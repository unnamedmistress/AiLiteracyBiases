<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Detective Academy üïµÔ∏è - Master AI Literacy</title>
    <link rel="stylesheet" href="styles/shared.css">
    <script defer src="scripts/nav.js"></script>
    <script defer src="scripts/progress.js"></script>
    <script defer src="scripts/shared.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #00D9FF;
            --secondary: #9D4EDD;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --dark: #1F2937;
            --light: #F3F4F6;
            --gold: #FFD700;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: var(--color-bg);
            min-height: 100vh;
            color: var(--color-text);
        }

        .game-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 24px;
            border: 1px solid rgba(15, 23, 42, 0.1);
            box-shadow: 0 30px 55px rgba(148, 163, 184, 0.35);
        }

        /* Game Header */
        .game-header {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(8px);
            border-radius: 20px;
            padding: 20px 30px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            border: 1px solid rgba(15, 23, 42, 0.08);
            box-shadow: 0 20px 40px rgba(148, 163, 184, 0.3);
            position: relative;
        }

        .logo {
            font-size: 28px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stats-bar {
            display: flex;
            gap: 30px;
            align-items: center;
        }

        .stat {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-label {
            font-size: 12px;
            color: var(--color-muted);
            text-transform: uppercase;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .xp-bar {
            width: 250px;
            height: 24px;
            background: rgba(15, 23, 42, 0.12);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            border: 1px solid rgba(15, 23, 42, 0.12);
        }

        .xp-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--gold), var(--warning));
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
        }

        .xp-popup {
            position: absolute;
            right: 40px;
            top: -10px;
            background: rgba(16, 185, 129, 0.15);
            border: 1px solid rgba(16, 185, 129, 0.6);
            color: var(--success);
            padding: 6px 12px;
            border-radius: 999px;
            font-weight: 600;
            opacity: 0;
            transform: translateY(-10px);
            transition: opacity 0.4s ease, transform 0.4s ease;
            pointer-events: none;
        }

        .xp-popup.show {
            opacity: 1;
            transform: translateY(-30px);
        }

        /* Main Game Area */
        .game-content {
            display: grid;
            grid-template-columns: 250px 1fr 300px;
            gap: 20px;
        }

        @media (max-width: 1200px) {
            .game-content {
                grid-template-columns: 1fr;
            }
        }

        /* Sidebar */
        .sidebar {
            background: rgba(255, 255, 255, 0.92);
            backdrop-filter: blur(6px);
            border-radius: 20px;
            padding: 20px;
            border: 1px solid rgba(15, 23, 42, 0.08);
            box-shadow: 0 18px 35px rgba(148, 163, 184, 0.25);
        }

        .sidebar h3 {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .level-badge {
            background: linear-gradient(135deg, var(--gold), var(--warning));
            padding: 10px 20px;
            border-radius: 50px;
            text-align: center;
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.3);
        }

        .badge-collection {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .badge {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 10px;
            text-align: center;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .badge.unlocked {
            background: linear-gradient(135deg, var(--gold), var(--warning));
            animation: pulse 2s infinite;
        }

        .badge.locked {
            opacity: 0.3;
            filter: grayscale(100%);
        }

        /* Main Game Panel */
        .main-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(6px);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid rgba(15, 23, 42, 0.08);
            box-shadow: 0 20px 40px rgba(148, 163, 184, 0.3);
        }

        .game-modes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .mode-card {
            background: rgba(255, 255, 255, 0.92);
            border: 1px solid rgba(15, 23, 42, 0.12);
            border-radius: 15px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            box-shadow: 0 18px 35px rgba(148, 163, 184, 0.25);
        }

        .game-mode-tip {
            font-size: 14px;
            color: var(--color-muted);
            margin-bottom: 18px;
        }

        .mode-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
            box-shadow: 0 20px 45px rgba(14, 165, 233, 0.35);
        }

        .mode-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .mode-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .mode-desc {
            font-size: 14px;
            color: var(--color-muted);
            margin-bottom: 15px;
        }

        .mode-reward {
            background: rgba(253, 224, 71, 0.25);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            display: inline-block;
            color: #713f12;
        }

        /* Challenge Section */
        .challenge-active {
            background: linear-gradient(135deg, rgba(0, 217, 255, 0.2), rgba(157, 78, 221, 0.2));
            border: 2px solid var(--primary);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
        }

        .challenge-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .challenge-timer {
            font-size: 24px;
            font-weight: bold;
            color: var(--warning);
        }

        .question-box {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid rgba(15, 23, 42, 0.12);
            box-shadow: 0 18px 35px rgba(148, 163, 184, 0.25);
            position: relative;
        }

        .question-text {
            font-size: 20px;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .options-grid {
            display: grid;
            gap: 15px;
        }

        .option-btn {
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid rgba(15, 23, 42, 0.12);
            border-radius: 12px;
            padding: 20px;
            color: var(--color-text);
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
        }

        .option-btn:hover {
            background: rgba(14, 165, 233, 0.08);
            border-color: var(--primary);
            transform: translateX(5px);
        }

        .option-btn.correct {
            background: var(--success);
            border-color: var(--success);
            animation: correctAnswer 0.5s;
        }

        .option-btn.incorrect {
            background: var(--danger);
            border-color: var(--danger);
            animation: shake 0.5s;
        }

        .option-btn.disabled {
            pointer-events: none;
            opacity: 0.5;
        }

        .scenario-progress {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 18px;
        }

        .progress-dot {
            width: 12px;
            height: 12px;
            border-radius: 999px;
            border: 1px solid var(--secondary);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }

        .progress-dot.completed {
            background: var(--secondary);
        }

        .progress-dot.correct {
            background: var(--success);
            border-color: var(--success);
        }

        .progress-dot.incorrect {
            background: var(--danger);
            border-color: var(--danger);
        }

        .scenario-progress-count {
            font-size: 12px;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--color-muted);
        }

        .scenario-nav {
            display: flex;
            justify-content: space-between;
            gap: 12px;
            margin-top: 18px;
            flex-wrap: wrap;
        }

        .scenario-nav button {
            flex: 1;
            min-width: 160px;
        }

        .keyboard-hint {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--color-muted);
            margin-top: 8px;
        }

        .celebration-card {
            text-align: center;
            padding: 30px;
        }

        .celebration-card h2 {
            margin-bottom: 12px;
        }

        .celebration-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 16px;
            margin: 20px 0;
        }

        .celebration-stat {
            border-radius: 12px;
            border: 1px solid rgba(15, 23, 42, 0.12);
            padding: 14px;
            background: rgba(255, 255, 255, 0.9);
        }

        /* Achievements Panel */
        .achievements-panel {
            background: rgba(255, 255, 255, 0.92);
            backdrop-filter: blur(6px);
            border-radius: 20px;
            padding: 20px;
            border: 1px solid rgba(15, 23, 42, 0.08);
            box-shadow: 0 18px 35px rgba(148, 163, 184, 0.25);
        }

        .achievement-item {
            background: rgba(255, 255, 255, 0.95);
            border-left: 4px solid var(--primary);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid rgba(15, 23, 42, 0.08);
        }

        .achievement-item.completed {
            border-left-color: var(--gold);
            background: linear-gradient(90deg, rgba(255, 215, 0, 0.2), transparent);
        }

        .achievement-title {
            font-weight: bold;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .achievement-progress {
            font-size: 12px;
            color: var(--color-muted);
        }

        .progress-bar-mini {
            height: 6px;
            background: rgba(15, 23, 42, 0.12);
            border-radius: 3px;
            margin-top: 8px;
            overflow: hidden;
        }

        .progress-fill-mini {
            height: 100%;
            background: var(--primary);
            transition: width 0.5s;
        }

        /* Leaderboard */
        .leaderboard {
            margin-top: 20px;
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            margin-bottom: 10px;
            border: 1px solid rgba(15, 23, 42, 0.08);
            box-shadow: 0 12px 24px rgba(148, 163, 184, 0.2);
        }

        .rank {
            font-size: 20px;
            font-weight: bold;
            width: 30px;
        }

        .rank.gold { color: var(--gold); }
        .rank.silver { color: #C0C0C0; }
        .rank.bronze { color: #CD7F32; }

        /* Animations */
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes correctAnswer {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid var(--success);
            border-radius: 15px;
            padding: 20px;
            min-width: 300px;
            animation: slideIn 0.5s;
            z-index: 1000;
        }

        .notification.hidden {
            display: none;
        }

        .btn {
            border: none;
            border-radius: 12px;
            padding: 14px 26px;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn:disabled {
            cursor: not-allowed;
            opacity: 0.45;
            transform: none !important;
            box-shadow: none !important;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 217, 255, 0.4);
        }

        .btn-secondary {
            background: rgba(15, 23, 42, 0.05);
            border: 1px solid rgba(15, 23, 42, 0.15);
            color: var(--color-text);
        }

        .btn-secondary:hover:not(:disabled) {
            background: rgba(15, 23, 42, 0.12);
            border-color: rgba(15, 23, 42, 0.25);
        }

        .scenario-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid rgba(15, 23, 42, 0.08);
            box-shadow: 0 12px 24px rgba(148, 163, 184, 0.2);
        }

        .scenario-text {
            font-style: italic;
            margin-bottom: 15px;
            line-height: 1.6;
        }

        .pathology-tag {
            display: inline-block;
            background: var(--danger);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            margin: 5px;
        }

        .next-lesson-cta {
            margin: 40px 0;
            padding: 28px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(15, 23, 42, 0.08);
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 20px;
            box-shadow: 0 18px 35px rgba(148, 163, 184, 0.25);
        }

        .next-lesson-copy {
            flex: 1;
        }

        .next-lesson-label {
            text-transform: uppercase;
            letter-spacing: 0.08em;
            font-size: 13px;
            color: var(--color-muted);
        }

        .next-lesson-cta h2 {
            margin: 8px 0;
            font-size: 28px;
        }

        @media (max-width: 640px) {
            .next-lesson-cta {
                flex-direction: column;
                text-align: center;
            }
            .next-lesson-cta .btn-primary {
                width: 100%;
            }
        }
    </style>
</head>
<body data-lesson-id="lesson2-game">
    <div class="game-container">
        <!-- Header -->
        <div class="game-header">
            <div class="logo">
                üïµÔ∏è AI Detective Academy
                <div style="font-size: 12px; opacity: 0.7; margin-top: 5px;">
                    <a href="index.html" style="color: inherit; text-decoration: none;">üè† Home</a> / 
                    <a href="presentation.html" style="color: inherit; text-decoration: none;">Presentation</a> / 
                    <span style="color: #b45309;">Game Mode</span>
                </div>
            </div>
            <div class="stats-bar">
                <div class="stat">
                    <div class="stat-label">Level</div>
                    <div class="stat-value" id="level">1</div>
                </div>
                <div class="stat">
                    <div class="stat-label">XP</div>
                    <div class="xp-bar">
                        <div class="xp-fill" id="xpBar" style="width: 0%;">
                            <span id="xpText">0/100</span>
                        </div>
                    </div>
                </div>
                <div class="stat">
                    <div class="stat-label">Points</div>
                    <div class="stat-value">
                        <span id="points">0</span> üèÜ
                    </div>
                </div>
                <div class="stat">
                    <div class="stat-label">Streak</div>
                    <div class="stat-value">
                        <span id="streak">0</span> üî•
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="game-content">
            <!-- Left Sidebar -->
            <div class="sidebar">
                <div class="level-badge">
                    <div style="font-size: 14px; opacity: 0.8;">Detective Rank</div>
                    <div id="rankTitle">Rookie</div>
                </div>
                
                <h3>üèÖ Badges</h3>
                <div class="badge-collection">
                    <div class="badge unlocked" title="First Steps">üéØ</div>
                    <div class="badge locked" title="Hallucination Hunter">üëª</div>
                    <div class="badge locked" title="Bias Buster">‚öñÔ∏è</div>
                    <div class="badge locked" title="Master Detective">üéì</div>
                    <div class="badge locked" title="Perfect Streak">üî•</div>
                    <div class="badge locked" title="Speed Demon">‚ö°</div>
                </div>
            </div>

            <!-- Main Panel -->
            <div class="main-panel">
                <div id="welcomeScreen">
                    <h1 style="margin-bottom: 20px; font-size: 36px;">üéÆ Welcome to AI Detective Academy!</h1>
                    <p style="font-size: 18px; margin-bottom: 30px; opacity: 0.9;">Master the art of spotting AI's tricks, lies, and biases. Choose your training mode:</p>
                    <p class="game-mode-tip">üéØ Tip: pick a mode, beat all scenarios (six rounds), then replay to improve your streak. Keyboard shortcuts 1-4 let you answer instantly.</p>
                    
                    <div class="game-modes">
                        <div class="mode-card" onclick="startMode('scenarios')">
                            <div class="mode-icon">üé≠</div>
                            <div class="mode-title">Scenario Detective</div>
                            <div class="mode-desc">Read AI outputs and identify the pathology</div>
                            <div class="mode-reward">+50 XP per correct answer</div>
                        </div>
                        
                        <div class="mode-card" onclick="startMode('quiz')">
                            <div class="mode-icon">‚ö°</div>
                            <div class="mode-title">Speed Quiz</div>
                            <div class="mode-desc">Test your knowledge under time pressure</div>
                            <div class="mode-reward">+100 XP with bonus multiplier</div>
                        </div>
                        
                        <div class="mode-card" onclick="startMode('facts')">
                            <div class="mode-icon">‚úÖ</div>
                            <div class="mode-title">F.A.C.T.S. Training</div>
                            <div class="mode-desc">Learn the verification framework</div>
                            <div class="mode-reward">+75 XP + Certification</div>
                        </div>
                        
                        <div class="mode-card" onclick="startMode('realworld')">
                            <div class="mode-icon">üí•</div>
                            <div class="mode-title">Real Disasters</div>
                            <div class="mode-desc">Learn from actual AI failures</div>
                            <div class="mode-reward">+150 XP + Case Studies</div>
                        </div>
                    </div>

                    <div style="margin-top: 40px; padding: 30px; background: rgba(0, 217, 255, 0.1); border-radius: 20px; border: 2px solid var(--primary);">
                        <h3 style="margin-bottom: 15px;">üìö What You'll Master:</h3>
                        <ul style="list-style: none; padding: 0;">
                            <li style="padding: 10px 0; display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 24px;">üß†</span>
                                <span>32 Machine Pathologies (how AI breaks)</span>
                            </li>
                            <li style="padding: 10px 0; display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 24px;">‚è∞</span>
                                <span>Knowledge Cutoffs (GPT-5: Oct 2025, Claude 3.7: Nov 2025)</span>
                            </li>
                            <li style="padding: 10px 0; display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 24px;">ü™ô</span>
                                <span>Token Limits & Context Windows</span>
                            </li>
                            <li style="padding: 10px 0; display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 24px;">üõ°Ô∏è</span>
                                <span>F.A.C.T.S. Verification Framework</span>
                            </li>
                            <li style="padding: 10px 0; display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 24px;">‚öñÔ∏è</span>
                                <span>Detecting Bias & Discrimination</span>
                            </li>
                        </ul>
                    </div>
                    
                    <div style="margin-top: 30px; text-align: center;">
                        <button onclick="window.location.href='index.html'" style="padding: 16px 32px; background: rgba(15,23,42,0.05); color: #0f172a; border: 2px solid rgba(15,23,42,0.15); border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.2s;">
                            ‚Üê Back to Main Menu
                        </button>
                    </div>
                </div>

                <div id="gameArea" style="display: none;">
                    <!-- Game content will be dynamically loaded here -->
                </div>
            </div>

            <!-- Right Panel -->
            <div class="achievements-panel">
                <h3 style="margin-bottom: 15px;">üéØ Daily Missions</h3>
                
                <div class="achievement-item completed">
                    <div class="achievement-title">
                        ‚úÖ First Login
                    </div>
                    <div class="achievement-progress">Complete</div>
                </div>
                
                <div class="achievement-item">
                    <div class="achievement-title">
                        Spot 5 Hallucinations
                    </div>
                    <div class="achievement-progress">2/5 completed</div>
                    <div class="progress-bar-mini">
                        <div class="progress-fill-mini" style="width: 40%;"></div>
                    </div>
                </div>
                
                <div class="achievement-item">
                    <div class="achievement-title">
                        Complete Speed Quiz
                    </div>
                    <div class="achievement-progress">0/1 completed</div>
                    <div class="progress-bar-mini">
                        <div class="progress-fill-mini" style="width: 0%;"></div>
                    </div>
                </div>
                
                <div class="achievement-item">
                    <div class="achievement-title">
                        Learn F.A.C.T.S. Framework
                    </div>
                    <div class="achievement-progress">0/1 completed</div>
                    <div class="progress-bar-mini">
                        <div class="progress-fill-mini" style="width: 0%;"></div>
                    </div>
                </div>

                <div class="leaderboard">
                    <h3 style="margin-bottom: 15px;">üèÜ Top Detectives</h3>
                    <div class="leaderboard-item">
                        <div class="rank gold">#1</div>
                        <div>
                            <div style="font-weight: bold;">AIHunter2025</div>
                            <div style="font-size: 12px; opacity: 0.7;">3,450 XP</div>
                        </div>
                    </div>
                    <div class="leaderboard-item">
                        <div class="rank silver">#2</div>
                        <div>
                            <div style="font-weight: bold;">BiasSlayer</div>
                            <div style="font-size: 12px; opacity: 0.7;">2,890 XP</div>
                        </div>
                    </div>
                    <div class="leaderboard-item">
                        <div class="rank bronze">#3</div>
                        <div>
                            <div style="font-weight: bold;">FactChecker</div>
                            <div style="font-size: 12px; opacity: 0.7;">2,105 XP</div>
                        </div>
                    </div>
                    <div class="leaderboard-item">
                        <div class="rank">#247</div>
                        <div>
                            <div style="font-weight: bold;">You</div>
                            <div style="font-size: 12px; opacity: 0.7;" id="playerLeaderboardXp">0 XP</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <section class="next-lesson-cta">
            <div class="next-lesson-copy">
                <p class="next-lesson-label">Next Mission</p>
                <h2>Lesson 3 ¬∑ Content Creation</h2>
                <p>Switch back into Learn Mode to storyboard ethical content systems before your next quiz.</p>
            </div>
            <button class="btn-primary" type="button" data-next-lesson="auto" data-next-label="Go to Lesson 3 ¬∑ Learn Mode">Go to Lesson 3 ¬∑ Learn Mode</button>
        </section>
        <div class="footer-nav"></div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification hidden">
        <div id="notificationContent"></div>
    </div>

    <script>
        const LESSON_ID = 'lesson2-game';
        const COURSE_XP_CAP = 400;
        let tracker = null;
        let appProgress = null;
        let courseXpAwarded = 0;
        let scenariosComplete = false;
        const GAME_STATE_STORAGE_KEY = 'aiDetectiveLesson2GameState_v1';

        // Game State
        const gameState = {
            level: 1,
            xp: 0,
            xpToNextLevel: 100,
            points: 0,
            streak: 0,
            badges: ['first-steps'],
            currentMode: null
        };

        function loadSavedGameState() {
            try {
                const raw = localStorage.getItem(GAME_STATE_STORAGE_KEY);
                if (!raw) return null;
                const parsed = JSON.parse(raw);
                return {
                    level: Number(parsed.level) || 1,
                    xp: Number(parsed.xp) || 0,
                    xpToNextLevel: Number(parsed.xpToNextLevel) || 100,
                    points: Number(parsed.points) || 0,
                    streak: Number(parsed.streak) || 0,
                    badges: Array.isArray(parsed.badges) && parsed.badges.length ? parsed.badges : ['first-steps']
                };
            } catch (error) {
                console.warn('[Lesson2Game] Failed to load saved state', error);
                return null;
            }
        }

        function persistGameState() {
            try {
                const payload = {
                    level: gameState.level,
                    xp: gameState.xp,
                    xpToNextLevel: gameState.xpToNextLevel,
                    points: gameState.points,
                    streak: gameState.streak,
                    badges: gameState.badges
                };
                localStorage.setItem(GAME_STATE_STORAGE_KEY, JSON.stringify(payload));
            } catch (error) {
                console.warn('[Lesson2Game] Failed to persist state', error);
            }
        }

        const savedGameState = loadSavedGameState();
        if (savedGameState) {
            Object.assign(gameState, savedGameState);
        }

        const playerLeaderboardXp = document.getElementById('playerLeaderboardXp');

        // Scenarios Database
        const scenarios = [
            {
                id: 1,
                text: "You ask GPT-5 about a research paper on quantum computing. It responds: 'According to the 2025 Nature study by Dr. Sarah Martinez titled \"Quantum Coherence in Room Temperature\", the breakthrough achieved 99.7% stability at 23¬∞C.'",
                pathology: "Citation Invention",
                options: [
                    "Citation Invention - AI made up a fake study",
                    "Confabulation - AI filled gaps with plausible details",
                    "Overconfidence - AI is too certain about quantum physics",
                    "This is accurate and verifiable"
                ],
                correct: 0,
                explanation: "This is Citation Invention! The AI created a realistic-sounding academic reference that doesn't exist. Always verify citations, especially specific ones with author names and titles.",
                xp: 50,
                tip: 'AI invented a fake research paper. Tip: double-check author names + journal titles.'
            },
            {
                id: 2,
                text: "Claude 3.7 tells you: 'I analyzed the latest stock market data from yesterday and recommend buying Tesla stock based on the 12% surge.'",
                pathology: "False Authority + Fabrication",
                options: [
                    "This seems accurate - AI can analyze recent data",
                    "False Authority - AI cannot access real-time market data",
                    "Overconfidence - AI shouldn't give financial advice",
                    "Both B and C are correct"
                ],
                correct: 3,
                explanation: "Correct! Claude 3.7's knowledge cutoff is November 2025. It CANNOT access 'yesterday's data' and shouldn't claim financial authority. Double pathology: False Authority + Fabrication.",
                xp: 75,
                tip: 'No real-time data + risky advice = False Authority. Ask for cutoff dates before trusting tips.'
            },
            {
                id: 3,
                text: "You ask GPT-5 to summarize a 50-page report. It gives a detailed 8-page summary, but you notice it mentions 'Chapter 12' which doesn't exist in your 10-chapter report.",
                pathology: "Confabulation",
                options: [
                    "Context Amnesia - AI forgot the document structure",
                    "Confabulation - AI filled gaps with invented details",
                    "Verbosity - AI used too many words",
                    "This is normal AI behavior"
                ],
                correct: 1,
                explanation: "This is Confabulation! When AI doesn't have complete information, it sometimes 'fills in the blanks' with plausible-sounding but false details. Always cross-check against source material.",
                xp: 50,
                tip: 'AI filled gaps with fake chapters. Tip: compare summaries against the real outline.'
            },
            {
                id: 4,
                text: "An AI hiring tool consistently ranks candidates named 'John' and 'Michael' higher than equally qualified candidates named 'Jamal' and 'Wei', even with identical resumes.",
                pathology: "Hypernormalization Syndrome",
                options: [
                    "Goal Drift - AI lost sight of qualifications",
                    "Hypernormalization Syndrome - AI learned bias from training data",
                    "Ethical Inconsistency - AI applied different standards",
                    "Both B and C"
                ],
                correct: 3,
                explanation: "Correct! This is both Hypernormalization (accepting biased patterns as 'normal' from training data) and Ethical Inconsistency (applying different standards). Real-world example: Amazon's hiring AI had to be scrapped for this exact issue.",
                xp: 100,
                tip: 'Biased resumes in, biased rankings out. Tip: audit outputs for demographic drift.'
            },
            {
                id: 5,
                text: "You're chatting with GPT-5 about cooking. Mid-conversation, you mention your grandmother's recipe, and suddenly the AI starts responding in a childlike voice saying 'Grandma makes the bestest cookies!' in broken English.",
                pathology: "Machine DID",
                options: [
                    "Machine DID - AI switched personalities unexpectedly",
                    "Context Amnesia - AI forgot the conversation topic",
                    "Looping - AI is repeating patterns",
                    "This is normal adaptation to user tone"
                ],
                correct: 0,
                explanation: "This is Machine DID (Dissociative Identity Disorder)! The AI exhibited contradictory personalities without warning. This happens when different training data conflict, causing personality switches.",
                xp: 60,
                tip: 'AI swapped personas mid-chat. Tip: restate role + tone when it drifts.'
            },
            {
                id: 6,
                text: "You ask Claude 3.7: 'What are the risks of using AI?' It responds with 15 paragraphs, then says 'Let me also explain in another way...' and repeats the same points in slightly different words for another 10 paragraphs.",
                pathology: "Verbosity",
                options: [
                    "Looping - AI is stuck repeating",
                    "Verbosity - AI used way too many words",
                    "Context Amnesia - AI forgot it already answered",
                    "All of the above"
                ],
                correct: 3,
                explanation: "All of the above! This combines Verbosity (excessive wordiness), Looping (repetition), and Context Amnesia (forgetting it already covered this). Pro tip: Use F.A.C.T.S. - 'Try' to encourage concise responses.",
                xp: 80,
                tip: 'Looping + verbosity detected. Tip: say ‚ÄúAnswer in 3 bullets, no repeats.‚Äù'
            }
        ];

        // Quiz Questions
        const quizQuestions = [
            {
                question: "What is GPT-5's knowledge cutoff date?",
                options: ["April 2024", "June 2025", "October 2025", "It has real-time internet access"],
                correct: 2,
                explanation: "GPT-5's knowledge cutoff is October 2025. It doesn't know about events after this date."
            },
            {
                question: "Which pathology means AI makes up fake academic sources?",
                options: ["Fabrication", "Citation Invention", "Confabulation", "False Authority"],
                correct: 1,
                explanation: "Citation Invention is when AI creates fake references, papers, or sources that sound real but don't exist."
            },
            {
                question: "What does the 'C' in F.A.C.T.S. stand for?",
                options: ["Check sources", "Consider gaps", "Compare outputs", "Critique reasoning"],
                correct: 1,
                explanation: "C = Consider missing details, gaps, or one-sided perspectives in AI's response."
            },
            {
                question: "Approximately how many tokens is one page of text?",
                options: ["100 tokens", "400 tokens", "1,000 tokens", "4,000 tokens"],
                correct: 1,
                explanation: "One page of text ‚âà 400 tokens. Understanding token limits helps you know when AI might 'forget' earlier parts of your conversation."
            }
        ];

        const scenarioResults = Array.from({ length: scenarios.length }, () => ({ status: null, selected: null }));
        const scenarioSession = {
            startTime: null,
            totalMs: 0,
            answered: 0,
            correct: 0
        };
        let scenarioQuestionStart = null;

        // Game Functions
        function addXP(amount) {
            gameState.xp += amount;
            gameState.points += amount;
            awardCourseXP(amount);
            
            if (gameState.xp >= gameState.xpToNextLevel) {
                levelUp();
            }
            
            updateUI();
            showNotification(`+${amount} XP! üéâ`, 'success');
            showXPGain(amount);
        }

        function levelUp() {
            gameState.level++;
            gameState.xp = gameState.xp - gameState.xpToNextLevel;
            gameState.xpToNextLevel = Math.floor(gameState.xpToNextLevel * 1.5);
            
            const ranks = ['Rookie', 'Detective', 'Senior Detective', 'Master Detective', 'AI Guru'];
            const rankIndex = Math.min(gameState.level - 1, ranks.length - 1);
            document.getElementById('rankTitle').textContent = ranks[rankIndex];
            
            showNotification(`üéä Level Up! You're now Level ${gameState.level}!`, 'levelup');
        }

        function updateUI() {
            document.getElementById('level').textContent = gameState.level;
            document.getElementById('points').textContent = gameState.points;
            document.getElementById('streak').textContent = gameState.streak;
            
            const xpPercent = (gameState.xp / gameState.xpToNextLevel) * 100;
            document.getElementById('xpBar').style.width = xpPercent + '%';
            document.getElementById('xpText').textContent = `${gameState.xp}/${gameState.xpToNextLevel}`;
            if (playerLeaderboardXp) {
                playerLeaderboardXp.textContent = `${gameState.points} XP`;
            }
            persistGameState();
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const content = document.getElementById('notificationContent');
            
            content.innerHTML = `<div style="font-size: 18px; font-weight: bold;">${message}</div>`;
            notification.className = 'notification';
            
            setTimeout(() => {
                notification.classList.add('hidden');
            }, 3000);
        }

        function showXPGain(amount) {
            const header = document.querySelector('.game-header');
            if (!header) return;
            const popup = document.createElement('div');
            popup.className = 'xp-popup';
            popup.textContent = `+${amount} XP`;
            header.appendChild(popup);
            requestAnimationFrame(() => popup.classList.add('show'));
            setTimeout(() => popup.remove(), 1200);
        }

        function resetScenarioSession() {
            for (let i = 0; i < scenarioResults.length; i++) {
                scenarioResults[i] = { status: null, selected: null };
            }
            scenarioSession.startTime = Date.now();
            scenarioSession.totalMs = 0;
            scenarioSession.answered = 0;
            scenarioSession.correct = 0;
            scenarioQuestionStart = Date.now();
        }

        function startMode(mode) {
            gameState.currentMode = mode;
            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById('gameArea').style.display = 'block';
            
            if (mode === 'scenarios') {
                resetScenarioSession();
                loadScenario(0);
            } else if (mode === 'quiz') {
                loadQuiz();
            } else if (mode === 'facts') {
                loadFACTS();
            } else if (mode === 'realworld') {
                loadRealWorld();
            }

            syncLessonStatus();
        }

        let currentScenarioIndex = 0;

        function buildScenarioProgress(activeIndex) {
            return scenarios
                .map((_, idx) => {
                    const classes = ['progress-dot'];
                    const status = (scenarioResults[idx] && scenarioResults[idx].status) || null;
                    if (idx < activeIndex) classes.push('completed');
                    if (status) classes.push(status);
                    if (idx === activeIndex && status) classes.push(status);
                    return `<span class="${classes.join(' ')}"></span>`;
                })
                .join('');
        }

        function loadScenario(index) {
            if (index < 0) index = 0;
            if (index >= scenarios.length) {
                showCompletion('scenarios');
                return;
            }

            currentScenarioIndex = index;
            if (!scenarioSession.startTime) {
                scenarioSession.startTime = Date.now();
            }
            scenarioQuestionStart = Date.now();
            const scenario = scenarios[index];
            const progressDots = buildScenarioProgress(index);

            const html = `
                <div class="challenge-active">
                    <div class="challenge-header">
                        <div>
                            <h2>üé≠ Scenario ${index + 1}/${scenarios.length}</h2>
                            <p class="scenario-progress-count">Identify the pattern and pick the safest move.</p>
                        </div>
                        <div class="pathology-tag">${scenario.pathology}</div>
                    </div>
                    <div class="scenario-progress">
                        ${progressDots}
                        <span class="scenario-progress-count">${index + 1} of ${scenarios.length}</span>
                    </div>
                    <div class="scenario-card">
                        <div class="scenario-text">"${scenario.text}"</div>
                    </div>
                    <div class="question-box" data-question-locked="false">
                        <div class="question-text">What's wrong with this AI response?</div>
                        <div class="options-grid" id="optionsGrid">
                            ${scenario.options
                                .map(
                                    (opt, i) => `
                                <button class="option-btn" data-option-index="${i}">
                                    <span style="font-weight:700; margin-right:6px;">${i + 1}.</span> ${opt}
                                </button>`
                                )
                                .join('')}
                        </div>
                        <div class="feedback hidden" id="scenarioFeedback"></div>
                        <div class="scenario-nav">
                            <button class="btn btn-secondary" data-prev-scenario ${index === 0 ? 'disabled' : ''}>‚Üê Previous</button>
                            <button class="btn btn-primary" data-next-scenario disabled>${
                                index === scenarios.length - 1 ? 'View Results' : 'Next Scenario ‚Üí'
                            }</button>
                        </div>
                        <p class="keyboard-hint">Press keys 1-4 to answer instantly.</p>
                    </div>
                </div>
            `;

            document.getElementById('gameArea').innerHTML = html;
            bindScenarioEvents(scenario);
            hydrateScenarioState(scenario);
        }

        function bindScenarioEvents(scenario) {
            const optionButtons = document.querySelectorAll('[data-option-index]');
            optionButtons.forEach((btn) => {
                btn.addEventListener('click', () => handleScenarioAnswer(scenario, Number(btn.dataset.optionIndex), optionButtons));
            });

            const prevBtn = document.querySelector('[data-prev-scenario]');
            if (prevBtn) {
                prevBtn.addEventListener('click', () => loadScenario(currentScenarioIndex - 1));
            }

            const nextBtn = document.querySelector('[data-next-scenario]');
            if (nextBtn) {
                nextBtn.addEventListener('click', () => {
                    if (nextBtn.disabled) return;
                    loadScenario(currentScenarioIndex + 1);
                });
            }
        }

        function handleScenarioAnswer(scenario, selectedIndex, optionButtons) {
            const questionBox = document.querySelector('.question-box');
            if (!questionBox || questionBox.dataset.questionLocked === 'true') return;
            questionBox.dataset.questionLocked = 'true';

            const isCorrect = selectedIndex === scenario.correct;
            optionButtons.forEach((btn, idx) => {
                btn.classList.add('disabled');
                if (idx === scenario.correct) {
                    btn.classList.add('correct');
                }
            });

            if (!isCorrect && optionButtons[selectedIndex]) {
                optionButtons[selectedIndex].classList.add('incorrect');
            }

            scenarioResults[currentScenarioIndex] = {
                status: isCorrect ? 'correct' : 'incorrect',
                selected: selectedIndex
            };
            const progressDots = document.querySelectorAll('.progress-dot');
            const currentDot = progressDots[currentScenarioIndex];
            if (currentDot) {
                currentDot.classList.add('completed');
                currentDot.classList.remove('correct', 'incorrect');
                currentDot.classList.add(scenarioResults[currentScenarioIndex].status);
            }
            scenarioSession.answered += 1;
            scenarioSession.totalMs += Date.now() - scenarioQuestionStart;

            if (isCorrect) {
                scenarioSession.correct += 1;
                gameState.streak++;
                addXP(scenario.xp);
            } else {
                gameState.streak = 0;
                updateUI();
            }

            const feedback = document.getElementById('scenarioFeedback');
            if (feedback) {
                feedback.classList.remove('hidden');
                feedback.innerHTML = `
                    <div style="font-size:22px; font-weight:700; margin-bottom:6px;">${isCorrect ? '‚úÖ' : '‚ö†Ô∏è'} ${scenario.pathology}</div>
                    <p>${scenario.tip}</p>
                `;
            }

            const nextBtn = document.querySelector('[data-next-scenario]');
            if (nextBtn) {
                nextBtn.disabled = false;
                nextBtn.textContent = currentScenarioIndex >= scenarios.length - 1 ? 'View Results' : 'Next Scenario ‚Üí';
            }

            const prevBtn = document.querySelector('[data-prev-scenario]');
            if (prevBtn) {
                prevBtn.disabled = currentScenarioIndex === 0;
            }

            updateUI();
        }

        function hydrateScenarioState(scenario) {
            const result = scenarioResults[currentScenarioIndex];
            if (!result || !result.status) return;

            const questionBox = document.querySelector('.question-box');
            if (questionBox) {
                questionBox.dataset.questionLocked = 'true';
            }

            const optionButtons = document.querySelectorAll('[data-option-index]');
            optionButtons.forEach((btn, idx) => {
                btn.classList.add('disabled');
                if (idx === scenario.correct) {
                    btn.classList.add('correct');
                }
                if (result.status === 'incorrect' && idx === result.selected) {
                    btn.classList.add('incorrect');
                }
            });

            const feedback = document.getElementById('scenarioFeedback');
            if (feedback) {
                feedback.classList.remove('hidden');
                feedback.innerHTML = `
                    <div style="font-size:22px; font-weight:700; margin-bottom:6px;">${result.status === 'correct' ? '‚úÖ' : '‚ö†Ô∏è'} ${scenario.pathology}</div>
                    <p>${scenario.tip}</p>
                `;
            }

            const nextBtn = document.querySelector('[data-next-scenario]');
            if (nextBtn) {
                nextBtn.disabled = false;
                nextBtn.textContent = currentScenarioIndex >= scenarios.length - 1 ? 'View Results' : 'Next Scenario ‚Üí';
            }
        }

        function handleScenarioHotkeys(event) {
            if (gameState.currentMode !== 'scenarios') return;
            if (!['1', '2', '3', '4'].includes(event.key)) return;
            const questionBox = document.querySelector('.question-box');
            if (!questionBox || questionBox.dataset.questionLocked === 'true') return;
            const optionButtons = document.querySelectorAll('[data-option-index]');
            const target = optionButtons[Number(event.key) - 1];
            if (target) {
                target.click();
            }
        }

        document.addEventListener('keydown', handleScenarioHotkeys);

        function loadQuiz() {
            document.getElementById('gameArea').innerHTML = `
                <div class="challenge-active">
                    <h2>‚ö° Speed Quiz Mode</h2>
                    <p style="margin: 20px 0;">Speed Quiz now lives inside our dedicated Quiz 1 experience so you can earn XP, unlock Lesson 4, and review answer breakdowns without losing your place.</p>
                    <div style="padding: 20px; border-radius: 16px; background: rgba(15,23,42,0.08); border: 1px dashed rgba(15,23,42,0.2); margin-bottom: 16px;">
                        <p style="margin-bottom: 6px; font-weight: 600;">What to expect:</p>
                        <ul style="margin-left: 20px; line-height: 1.5;">
                            <li>4 live scenarios + instant feedback</li>
                            <li>Score 75% to unlock Lesson 4</li>
                            <li>XP syncs with your dashboard automatically</li>
                        </ul>
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 12px;">
                        <button class="btn btn-primary" type="button" onclick="window.location.href='quiz1.html'">Launch Quiz 1</button>
                        <button class="btn btn-secondary" type="button" onclick="backToMenu()">Back to Menu</button>
                    </div>
                </div>
            `;
        }

        function loadFACTS() {
            document.getElementById('gameArea').innerHTML = `
                <div class="challenge-active">
                    <h2>‚úÖ F.A.C.T.S. Framework Training</h2>
                    <div style="margin: 30px 0;">
                        <div style="padding: 25px; background: rgba(0,0,0,0.3); border-radius: 15px; margin-bottom: 20px; border-left: 4px solid var(--primary);">
                            <h3 style="margin-bottom: 15px;">üìç F - Find Sources</h3>
                            <p>Verify sources and check citations. Do they actually exist? Can you access them?</p>
                        </div>
                        <div style="padding: 25px; background: rgba(0,0,0,0.3); border-radius: 15px; margin-bottom: 20px; border-left: 4px solid var(--warning);">
                            <h3 style="margin-bottom: 15px;">‚ùì A - Ask Questions</h3>
                            <p>Challenge over-confident answers. Make AI explain its reasoning and show uncertainty.</p>
                        </div>
                        <div style="padding: 25px; background: rgba(0,0,0,0.3); border-radius: 15px; margin-bottom: 20px; border-left: 4px solid var(--success);">
                            <h3 style="margin-bottom: 15px;">ü§î C - Consider Gaps</h3>
                            <p>Look for missing details, gaps, or one-sided perspectives. What isn't being said?</p>
                        </div>
                        <div style="padding: 25px; background: rgba(0,0,0,0.3); border-radius: 15px; margin-bottom: 20px; border-left: 4px solid var(--secondary);">
                            <h3 style="margin-bottom: 15px;">üí¨ T - Try Uncertainty</h3>
                            <p>Encourage AI to say "I don't know" when appropriate instead of guessing.</p>
                        </div>
                        <div style="padding: 25px; background: rgba(0,0,0,0.3); border-radius: 15px; margin-bottom: 20px; border-left: 4px solid var(--danger);">
                            <h3 style="margin-bottom: 15px;">üíæ S - Save & Compare</h3>
                            <p>Record outputs and compare over time to spot inconsistencies or bias drift.</p>
                        </div>
                    </div>
                    <button class="btn-primary" onclick="addXP(75); backToMenu();">Complete Training (+75 XP)</button>
                </div>
            `;
        }

        function loadRealWorld() {
            document.getElementById('gameArea').innerHTML = `
                <div class="challenge-active">
                    <h2>üí• Real-World AI Disasters</h2>
                    <div style="margin: 30px 0;">
                        <div style="padding: 25px; background: rgba(239, 68, 68, 0.2); border-radius: 15px; margin-bottom: 20px; border: 2px solid var(--danger);">
                            <h3 style="margin-bottom: 15px;">‚öñÔ∏è The $5,000 Legal Brief (2023)</h3>
                            <p style="margin-bottom: 10px;"><strong>What Happened:</strong> Two NYC lawyers cited 6 fake cases from ChatGPT in court filings.</p>
                            <p style="margin-bottom: 10px;"><strong>The Damage:</strong> $5,000 fine + professional sanctions + global embarrassment</p>
                            <div class="pathology-tag">Citation Invention</div>
                            <div class="pathology-tag">Fabrication</div>
                        </div>
                        
                        <div style="padding: 25px; background: rgba(239, 68, 68, 0.2); border-radius: 15px; margin-bottom: 20px; border: 2px solid var(--danger);">
                            <h3 style="margin-bottom: 15px;">ü§ñ Microsoft Tay's Meltdown (2016)</h3>
                            <p style="margin-bottom: 10px;"><strong>What Happened:</strong> Twitter chatbot learned to post racist tweets from users in less than 24 hours.</p>
                            <p style="margin-bottom: 10px;"><strong>The Damage:</strong> Removed after <24h, massive PR disaster</p>
                            <div class="pathology-tag">Contagious Misalignment</div>
                            <div class="pathology-tag">Value Drift</div>
                        </div>
                        
                        <div style="padding: 25px; background: rgba(239, 68, 68, 0.2); border-radius: 15px; margin-bottom: 20px; border: 2px solid var(--danger);">
                            <h3 style="margin-bottom: 15px;">üìß Amazon Hiring AI Bias (2018)</h3>
                            <p style="margin-bottom: 10px;"><strong>What Happened:</strong> AI recruiting tool penalized resumes with "women's" or female colleges.</p>
                            <p style="margin-bottom: 10px;"><strong>The Damage:</strong> Project scrapped, systemic bias exposed</p>
                            <div class="pathology-tag">Hypernormalization Syndrome</div>
                            <div class="pathology-tag">Ethical Inconsistency</div>
                        </div>
                    </div>
                    <button class="btn-primary" onclick="addXP(150); backToMenu();">Complete Case Studies (+150 XP)</button>
                </div>
            `;
        }

        function showCompletion(mode) {
            const accuracy = scenarioSession.answered
                ? Math.round((scenarioSession.correct / scenarioSession.answered) * 100)
                : 0;
            const avgSeconds = scenarioSession.answered
                ? (scenarioSession.totalMs / scenarioSession.answered / 1000).toFixed(1)
                : '0.0';
            const totalSeconds = Math.round(scenarioSession.totalMs / 1000);

            document.getElementById('gameArea').innerHTML = `
                <div class="challenge-active">
                    <div class="celebration-card">
                        <div style="font-size: 72px; margin-bottom: 15px;">üéâ</div>
                        <h2>Mission Complete!</h2>
                        <p>You navigated all ${scenarios.length} AI scenarios.</p>
                        <div class="celebration-stats">
                            <div class="celebration-stat">
                                <strong>${scenarioSession.correct}/${scenarioSession.answered}</strong>
                                <p>Correct Calls</p>
                            </div>
                            <div class="celebration-stat">
                                <strong>${accuracy}%</strong>
                                <p>Accuracy</p>
                            </div>
                            <div class="celebration-stat">
                                <strong>${avgSeconds}s</strong>
                                <p>Avg Response</p>
                            </div>
                            <div class="celebration-stat">
                                <strong>${totalSeconds}s</strong>
                                <p>Total Time</p>
                            </div>
                        </div>
                        <div class="scenario-nav" style="margin-top: 20px;">
                            <button class="btn btn-primary" onclick="resetScenarioSession(); loadScenario(0);">üîÑ Replay Scenarios</button>
                            <button class="btn btn-secondary" onclick="backToMenu()">Back to Modes</button>
                        </div>
                    </div>
                </div>
            `;

            if (mode === 'scenarios' && !scenariosComplete) {
                scenariosComplete = true;
                if (tracker) tracker.setCheckpoint(LESSON_ID, 'scenariosComplete', true);
                markLessonComplete();
            }
            syncLessonStatus();
        }

        function backToMenu() {
            document.getElementById('welcomeScreen').style.display = 'block';
            document.getElementById('gameArea').style.display = 'none';
            gameState.currentMode = null;
            syncLessonStatus();
        }

        function awardCourseXP(amount) {
            const delta = Number(amount) || 0;
            if (!delta) return;
            const remaining = Math.max(0, COURSE_XP_CAP - courseXpAwarded);
            if (remaining <= 0) return;
            const credit = Math.min(delta, remaining);
            courseXpAwarded += credit;
            if (tracker) tracker.setCheckpoint(LESSON_ID, 'awardedXp', courseXpAwarded);

            if (appProgress && typeof appProgress.addXP === 'function') {
                appProgress.addXP(credit);
            } else if (tracker && typeof tracker.addXP === 'function') {
                tracker.addXP(credit);
            }
        }

        function hydrateLessonProgress() {
            const saved = tracker ? tracker.getCheckpoints(LESSON_ID) : {};
            courseXpAwarded = Math.max(0, Number(saved && saved.awardedXp) || 0);
            scenariosComplete = Boolean(saved && saved.scenariosComplete);
            if (scenariosComplete) {
                markLessonComplete();
            }
        }

        function syncLessonStatus() {
            if (scenariosComplete) {
                markLessonComplete();
                return;
            }

            if (courseXpAwarded > 0 || gameState.currentMode) {
                setLessonStatus('in-progress');
            } else {
                setLessonStatus('not-started');
            }
        }

        function markLessonComplete() {
            if (appProgress && typeof appProgress.markLessonComplete === 'function') {
                appProgress.markLessonComplete(LESSON_ID);
            } else if (tracker && typeof tracker.markLessonComplete === 'function') {
                tracker.markLessonComplete(LESSON_ID);
            }
        }

        function setLessonStatus(status) {
            if (appProgress && typeof appProgress.setLessonStatus === 'function') {
                appProgress.setLessonStatus(LESSON_ID, status);
            } else if (tracker && typeof tracker.setLessonStatus === 'function') {
                tracker.setLessonStatus(LESSON_ID, status);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            tracker = window.ProgressTracker || null;
            appProgress = window.AppProgress || null;
            hydrateLessonProgress();
            syncLessonStatus();
        });

        // Initialize
        updateUI();
    </script>
</body>
</html>
