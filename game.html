<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self'; connect-src 'self';">
    <title>AI Detective Academy üïµÔ∏è - Master AI Literacy</title>
    <link rel="stylesheet" href="styles/shared.css">
    <script defer src="scripts/nav.js"></script>
    <script defer src="scripts/progress.js"></script>
    <script defer src="scripts/shared.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #00D9FF;
            --secondary: #9D4EDD;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --dark: #1F2937;
            --light: #F3F4F6;
            --gold: #FFD700;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: var(--color-bg);
            min-height: 100vh;
            color: var(--color-text);
        }

        .game-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 24px;
            border: 1px solid rgba(15, 23, 42, 0.1);
            box-shadow: 0 30px 55px rgba(148, 163, 184, 0.35);
        }

        /* Game Header */
        .game-header {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(8px);
            border-radius: 18px;
            padding: 16px 20px;
            margin-bottom: 16px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: wrap;
            gap: 16px;
            border: 1px solid rgba(15, 23, 42, 0.08);
            box-shadow: 0 12px 30px rgba(148, 163, 184, 0.25);
            position: relative;
        }

        .logo {
            font-size: 28px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stats-bar {
            display: flex;
            gap: 18px;
            align-items: center;
            flex-wrap: wrap;
        }

        .stat {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            min-width: 90px;
        }

        .stat-xp {
            min-width: 240px;
        }

        .xp-progress {
            width: 260px;
            max-width: 100%;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .xp-progress .xp-readout {
            text-align: left;
        }

        .stat-label {
            font-size: 12px;
            color: var(--color-muted);
            text-transform: uppercase;
        }

        .stat-value {
            font-size: 20px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .xp-bar {
            width: 100%;
            height: 24px;
            background: rgba(15, 23, 42, 0.12);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            border: 1px solid rgba(15, 23, 42, 0.12);
        }

        .xp-fill {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            background: linear-gradient(90deg, var(--gold), var(--warning));
            transition: width 0.5s ease;
        }

        .xp-label {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            color: #0f172a;
        }

        .xp-popup {
            position: absolute;
            right: 40px;
            top: -10px;
            background: rgba(16, 185, 129, 0.15);
            border: 1px solid rgba(16, 185, 129, 0.6);
            color: var(--success);
            padding: 6px 12px;
            border-radius: 999px;
            font-weight: 600;
            opacity: 0;
            transform: translateY(-10px);
            transition: opacity 0.4s ease, transform 0.4s ease;
            pointer-events: none;
        }

        .xp-popup.show {
            opacity: 1;
            transform: translateY(-30px);
        }

        /* Main Game Area */
        .game-content {
            display: grid;
            grid-template-columns: minmax(0, 1fr) 260px;
            gap: 18px;
        }

        @media (max-width: 1200px) {
            .game-content {
                grid-template-columns: 1fr;
            }
        }

        .rank-chip {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 10px;
            border-radius: 999px;
            background: rgba(253, 224, 71, 0.25);
            font-size: 12px;
            font-weight: 600;
            color: #92400e;
            border: 1px solid rgba(146, 64, 14, 0.15);
            margin-left: 6px;
            white-space: nowrap;
        }

        .badge-strip {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: rgba(15, 23, 42, 0.04);
            border-radius: 999px;
            border: 1px solid rgba(15, 23, 42, 0.08);
        }

        .badge-strip-label {
            font-size: 12px;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: rgba(15, 23, 42, 0.8);
        }

        .badge-strip-icons {
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
        }

        .badge-icon {
            width: 30px;
            height: 30px;
            border-radius: 10px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(15, 23, 42, 0.08);
        }

        .badge-icon.unlocked {
            background: linear-gradient(135deg, var(--gold), var(--warning));
            color: #92400e;
            box-shadow: 0 4px 8px rgba(244, 114, 182, 0.25);
        }

        .badge-icon.locked {
            opacity: 0.35;
        }

        /* Main Game Panel */
        .main-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(4px);
            border-radius: 16px;
            padding: 22px;
            border: 1px solid rgba(15, 23, 42, 0.08);
            box-shadow: 0 16px 30px rgba(148, 163, 184, 0.25);
        }

        .game-modes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .mode-card {
            background: rgba(255, 255, 255, 0.92);
            border: 1px solid rgba(15, 23, 42, 0.12);
            border-radius: 15px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            box-shadow: 0 18px 35px rgba(148, 163, 184, 0.25);
        }

        .game-mode-tip {
            font-size: 14px;
            color: var(--color-muted);
            margin-bottom: 18px;
        }
        .resume-panel {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            border-radius: 16px;
            border: 1px solid rgba(15, 23, 42, 0.15);
            background: rgba(14, 165, 233, 0.08);
        }
        .resume-panel.hidden {
            display: none;
        }
        .resume-details {
            flex: 1 1 220px;
        }
        .resume-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        .resume-progress {
            font-size: 14px;
            color: rgba(15, 23, 42, 0.75);
        }
        .resume-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .mode-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
            box-shadow: 0 20px 45px rgba(14, 165, 233, 0.35);
        }

        .mode-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .mode-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .mode-desc {
            font-size: 14px;
            color: var(--color-muted);
            margin-bottom: 15px;
        }

        .mode-reward {
            background: rgba(253, 224, 71, 0.25);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            display: inline-block;
            color: #713f12;
        }

        /* Challenge Section */
        .challenge-active {
            background: linear-gradient(135deg, rgba(0, 217, 255, 0.2), rgba(157, 78, 221, 0.2));
            border: 2px solid var(--primary);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
        }

        .challenge-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .challenge-timer {
            font-size: 24px;
            font-weight: bold;
            color: var(--warning);
        }

        .question-box {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 14px;
            padding: 18px;
            margin-bottom: 16px;
            border: 1px solid rgba(15, 23, 42, 0.12);
            box-shadow: 0 12px 24px rgba(148, 163, 184, 0.2);
            position: relative;
        }


        .question-text {
            font-size: 18px;
            margin-bottom: 16px;
            line-height: 1.5;
        }

        .options-grid {
            display: grid;
            gap: 15px;
        }

        .option-btn {
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid rgba(15, 23, 42, 0.12);
            border-radius: 10px;
            padding: 16px;
            color: var(--color-text);
            font-size: 15px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
        }

        .option-btn:hover {
            background: rgba(14, 165, 233, 0.08);
            border-color: var(--primary);
            transform: translateX(5px);
        }

        .option-btn.correct {
            background: var(--success);
            border-color: var(--success);
            animation: correctAnswer 0.5s;
        }

        .option-btn.incorrect {
            background: var(--danger);
            border-color: var(--danger);
            animation: shake 0.5s;
        }

        .option-btn.disabled {
            pointer-events: none;
            opacity: 0.5;
        }

        .scenario-progress {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 18px;
        }

        .progress-dot {
            width: 12px;
            height: 12px;
            border-radius: 999px;
            border: 1px solid var(--secondary);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }

        .progress-dot.completed {
            background: var(--secondary);
        }

        .progress-dot.correct {
            background: var(--success);
            border-color: var(--success);
        }

        .progress-dot.incorrect {
            background: var(--danger);
            border-color: var(--danger);
        }

        .scenario-progress-count {
            font-size: 12px;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--color-muted);
        }

        .scenario-nav {
            display: flex;
            justify-content: space-between;
            gap: 12px;
            margin-top: 18px;
            flex-wrap: wrap;
        }

        .scenario-nav button {
            flex: 1;
            min-width: 160px;
        }

        .keyboard-hint {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--color-muted);
            margin-top: 8px;
        }

        .celebration-card {
            text-align: center;
            padding: 30px;
        }

        .celebration-card h2 {
            margin-bottom: 12px;
        }

        .celebration-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 16px;
            margin: 20px 0;
        }

        .celebration-stat {
            border-radius: 12px;
            border: 1px solid rgba(15, 23, 42, 0.12);
            padding: 14px;
            background: rgba(255, 255, 255, 0.9);
        }

        /* Achievements Panel */
        .achievements-panel {
            background: rgba(255, 255, 255, 0.92);
            backdrop-filter: blur(4px);
            border-radius: 16px;
            padding: 14px;
            border: 1px solid rgba(15, 23, 42, 0.08);
            box-shadow: 0 10px 20px rgba(148, 163, 184, 0.2);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            font-size: 14px;
        }

        .panel-header h3 {
            margin: 0;
            font-size: 15px;
        }

        .panel-pill {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            padding: 2px 10px;
            border-radius: 999px;
            background: rgba(15, 23, 42, 0.06);
            color: rgba(15, 23, 42, 0.8);
        }

        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 10px;
        }

        @media (max-width: 1200px) {
            .achievements-grid,
            .leaderboard-grid {
                grid-template-columns: 1fr;
            }
        }

        .achievement-item {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 10px 12px;
            border: 1px solid rgba(15, 23, 42, 0.08);
            display: flex;
            flex-direction: column;
            gap: 4px;
            min-height: 84px;
        }

        .achievement-item.completed {
            border-color: rgba(255, 215, 0, 0.5);
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.15), rgba(255, 255, 255, 0.9));
        }

        .achievement-title {
            font-weight: 600;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .achievement-progress {
            font-size: 11px;
            color: var(--color-muted);
        }

        .progress-bar-mini {
            height: 4px;
            background: rgba(15, 23, 42, 0.12);
            border-radius: 999px;
            overflow: hidden;
        }

        .progress-fill-mini {
            height: 100%;
            background: var(--primary);
            transition: width 0.4s;
        }

        /* Leaderboard */
        .leaderboard {
            margin-top: 4px;
        }

        .leaderboard-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            border: 1px solid rgba(15, 23, 42, 0.08);
        }

        .rank {
            font-size: 16px;
            font-weight: 600;
            width: 26px;
        }

        .rank.gold { color: var(--gold); }
        .rank.silver { color: #C0C0C0; }
        .rank.bronze { color: #CD7F32; }

        /* Animations */
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes correctAnswer {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(15, 23, 42, 0.95);
            color: #f8fafc;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 20px;
            min-width: 300px;
            box-shadow: 0 16px 32px rgba(15, 23, 42, 0.5);
            animation: slideIn 0.5s;
            z-index: 1000;
        }

        .notification.hidden {
            display: none;
        }

        .btn {
            border: none;
            border-radius: 12px;
            padding: 14px 26px;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn:disabled {
            cursor: not-allowed;
            opacity: 0.45;
            transform: none !important;
            box-shadow: none !important;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 217, 255, 0.4);
        }

        .btn-secondary {
            background: rgba(15, 23, 42, 0.05);
            border: 1px solid rgba(15, 23, 42, 0.15);
            color: var(--color-text);
        }

        .btn-secondary:hover:not(:disabled) {
            background: rgba(15, 23, 42, 0.12);
            border-color: rgba(15, 23, 42, 0.25);
        }

        .scenario-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid rgba(15, 23, 42, 0.08);
            box-shadow: 0 12px 24px rgba(148, 163, 184, 0.2);
        }

        .scenario-text {
            font-style: italic;
            margin-bottom: 15px;
            line-height: 1.6;
        }

        .pathology-tag {
            display: inline-block;
            background: rgba(148, 163, 184, 0.25);
            color: rgba(15, 23, 42, 0.8);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            margin: 5px;
            transition: background 0.2s ease, color 0.2s ease;
        }

        .pathology-tag.revealed {
            background: var(--danger);
            color: #fff;
        }

        .next-lesson-cta {
            margin: 40px 0;
            padding: 28px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(15, 23, 42, 0.08);
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 20px;
            box-shadow: 0 18px 35px rgba(148, 163, 184, 0.25);
        }

        .next-lesson-copy {
            flex: 1;
        }

        .next-lesson-label {
            text-transform: uppercase;
            letter-spacing: 0.08em;
            font-size: 13px;
            color: var(--color-muted);
        }

        .next-lesson-cta h2 {
            margin: 8px 0;
            font-size: 28px;
        }

        @media (max-width: 900px) {
            .game-header {
                flex-direction: column;
                align-items: stretch;
            }
            .stats-bar {
                width: 100%;
                justify-content: space-between;
            }
            .badge-strip {
                width: 100%;
                justify-content: space-between;
            }
        }

        @media (max-width: 768px) {
            .stats-bar {
                gap: 12px;
            }
            .stat {
                flex: 1 1 140px;
            }
            .badge-strip {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
        }

        @media (max-width: 640px) {
            .next-lesson-cta {
                flex-direction: column;
                text-align: center;
            }
            .next-lesson-cta .btn-primary {
                width: 100%;
            }
            .stats-bar {
                flex-direction: column;
                align-items: stretch;
            }
            .xp-progress {
                width: 100%;
            }
            .xp-bar {
                height: 20px;
            }
            .resume-panel {
                flex-direction: column;
                align-items: flex-start;
            }
            .resume-actions {
                width: 100%;
                flex-direction: column;
            }
            .resume-actions .btn-primary,
            .resume-actions .btn-secondary {
                width: 100%;
            }
            .game-modes {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body data-lesson-id="lesson2-game">
    <div class="game-container">
        <!-- Header -->
        <div class="game-header">
            <div class="logo">
                üïµÔ∏è AI Detective Academy
                <div style="font-size: 12px; opacity: 0.7; margin-top: 5px;">
                    <a href="index.html" style="color: inherit; text-decoration: none;">üè† Home</a> / 
                    <a href="presentation.html" style="color: inherit; text-decoration: none;">Presentation</a> / 
                    <span style="color: #b45309;">Game Mode</span>
                </div>
            </div>
            <div class="stats-bar">
                <div class="stat">
                    <div class="stat-label">Level</div>
                    <div class="stat-value" id="level">2</div>
                </div>
                <div class="stat stat-xp">
                    <div class="stat-label">XP</div>
                    <div class="xp-progress">
                        <div class="xp-bar">
                            <div class="xp-fill" id="xpBar" style="width: 0%;"></div>
                            <span class="xp-label" id="xpText">0/225</span>
                        </div>
                        <div class="xp-readout" id="xpReadout" aria-live="polite">0/225 XP</div>
                    </div>
                </div>
                <div class="stat">
                    <div class="stat-label">Points</div>
                    <div class="stat-value">
                        <span id="points">0</span> üèÜ
                    </div>
                </div>
                <div class="stat">
                    <div class="stat-label">Streak</div>
                    <div class="stat-value">
                        <span id="streak">0</span> üî•
                        <span class="rank-chip" title="Detective Rank" aria-label="Detective Rank">
                            üéñÔ∏è <span id="rankTitle">Rookie</span>
                        </span>
                    </div>
                </div>
            </div>

            <div class="badge-strip" aria-label="Badge progress">
                <div class="badge-strip-label">Badges</div>
                <div class="badge-strip-icons">
                    <span class="badge-icon unlocked" title="First Steps">üéØ</span>
                    <span class="badge-icon locked" title="Hallucination Hunter">üëª</span>
                    <span class="badge-icon locked" title="Bias Buster">‚öñÔ∏è</span>
                    <span class="badge-icon locked" title="Master Detective">üéì</span>
                    <span class="badge-icon locked" title="Perfect Streak">üî•</span>
                    <span class="badge-icon locked" title="Speed Demon">‚ö°</span>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="game-content">
            <div class="main-panel">
                <div id="welcomeScreen">
                    <h1 style="margin-bottom: 20px; font-size: 36px;">üéÆ Welcome to AI Detective Academy!</h1>
                    <p style="font-size: 18px; margin-bottom: 30px; opacity: 0.9;">Master the art of spotting AI's tricks, lies, and biases. Choose your training mode:</p>
                    <p class="game-mode-tip">üéØ Tip: pick a mode, beat all scenarios (six rounds), then replay to improve your streak. Keyboard shortcuts 1-4 let you answer instantly.</p>
                    <div class="resume-panel hidden" id="resumePanel">
                        <div class="resume-details">
                            <div class="resume-title">Resume Scenario Run</div>
                            <div class="resume-progress" id="resumeProgressLabel">0/6 scenarios completed</div>
                        </div>
                        <div class="resume-actions">
                            <button class="btn-primary" type="button" id="resumeScenarioBtn">Resume</button>
                            <button class="btn-secondary" type="button" id="restartScenarioBtn">Start Over</button>
                        </div>
                    </div>
                    
                    <div class="game-modes">
                        <div class="mode-card" onclick="startMode('scenarios')">
                            <div class="mode-icon">üé≠</div>
                            <div class="mode-title">Scenario Detective</div>
                            <div class="mode-desc">Read AI outputs and identify the pathology</div>
                            <div class="mode-reward">+50 XP per correct answer</div>
                        </div>
                        
                        <div class="mode-card" onclick="startMode('quiz')">
                            <div class="mode-icon">‚ö°</div>
                            <div class="mode-title">Speed Quiz</div>
                            <div class="mode-desc">Test your knowledge under time pressure</div>
                            <div class="mode-reward">+100 XP with bonus multiplier</div>
                        </div>
                        
                        <div class="mode-card" onclick="startMode('realworld')">
                            <div class="mode-icon">üí•</div>
                            <div class="mode-title">Real Disasters</div>
                            <div class="mode-desc">Learn from actual AI failures</div>
                            <div class="mode-reward">+150 XP + Case Studies</div>
                        </div>
                    </div>

                    <div style="margin-top: 40px; padding: 30px; background: rgba(0, 217, 255, 0.1); border-radius: 20px; border: 2px solid var(--primary);">
                        <h3 style="margin-bottom: 15px;">üìö What You'll Master:</h3>
                        <ul style="list-style: none; padding: 0;">
                            <li style="padding: 10px 0; display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 24px;">üß†</span>
                                <span>32 Machine Pathologies (how AI breaks)</span>
                            </li>
                            <li style="padding: 10px 0; display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 24px;">‚è∞</span>
                                <span>Knowledge Cutoffs (GPT-5: Oct 2025, Claude 3.7: Nov 2025)</span>
                            </li>
                            <li style="padding: 10px 0; display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 24px;">ü™ô</span>
                                <span>Token Limits & Context Windows</span>
                            </li>
                            <li style="padding: 10px 0; display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 24px;">üõ°Ô∏è</span>
                                <span>F.A.C.T.S. Verification Framework</span>
                            </li>
                            <li style="padding: 10px 0; display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 24px;">‚öñÔ∏è</span>
                                <span>Detecting Bias & Discrimination</span>
                            </li>
                        </ul>
                    </div>
                    
                    <div style="margin-top: 30px; text-align: center;">
                        <button onclick="window.location.href='index.html'" style="padding: 16px 32px; background: rgba(15,23,42,0.05); color: #0f172a; border: 2px solid rgba(15,23,42,0.15); border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.2s;">
                            ‚Üê Back to Main Menu
                        </button>
                    </div>
                </div>

                <div id="gameArea" style="display: none;">
                    <!-- Game content will be dynamically loaded here -->
                </div>
            </div>

            <!-- Right Panel -->
            <div class="achievements-panel">
                <div class="panel-header">
                    <h3>üéØ Daily Missions</h3>
                    <span class="panel-pill">3 quests</span>
                </div>
                <div class="achievements-grid">
                    <div class="achievement-item completed">
                        <div class="achievement-title">‚úÖ First Login</div>
                        <div class="achievement-progress">Complete</div>
                    </div>
                    <div class="achievement-item">
                        <div class="achievement-title">Spot 5 Hallucinations</div>
                        <div class="achievement-progress">2/5 completed</div>
                        <div class="progress-bar-mini">
                            <div class="progress-fill-mini" style="width: 40%;"></div>
                        </div>
                    </div>
                    <div class="achievement-item">
                        <div class="achievement-title">Complete Speed Quiz</div>
                        <div class="achievement-progress">0/1 completed</div>
                        <div class="progress-bar-mini">
                            <div class="progress-fill-mini" style="width: 0%;"></div>
                        </div>
                    </div>
                </div>

                <div class="leaderboard">
                    <div class="panel-header">
                        <h3>üèÜ Top Detectives</h3>
                        <span class="panel-pill">Live</span>
                    </div>
                    <div class="leaderboard-grid">
                        <div class="leaderboard-item">
                            <div class="rank gold">#1</div>
                            <div>
                                <div style="font-weight: bold;">AIHunter2025</div>
                                <div style="font-size: 12px; opacity: 0.7;">3,450 XP</div>
                            </div>
                        </div>
                        <div class="leaderboard-item">
                            <div class="rank silver">#2</div>
                            <div>
                                <div style="font-weight: bold;">BiasSlayer</div>
                                <div style="font-size: 12px; opacity: 0.7;">2,890 XP</div>
                            </div>
                        </div>
                        <div class="leaderboard-item">
                            <div class="rank bronze">#3</div>
                            <div>
                                <div style="font-weight: bold;">FactChecker</div>
                                <div style="font-size: 12px; opacity: 0.7;">2,105 XP</div>
                            </div>
                        </div>
                        <div class="leaderboard-item">
                            <div class="rank">#247</div>
                            <div>
                                <div style="font-weight: bold;">You</div>
                                <div style="font-size: 12px; opacity: 0.7;" id="playerLeaderboardXp">0 XP</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <section class="next-lesson-cta">
            <div class="next-lesson-copy">
                <p class="next-lesson-label">Next Mission</p>
                <h2>Quiz 1 ¬∑ Warm-Up Review</h2>
                <p>Test your instincts on hallucinations and bias before moving to Content Creation.</p>
            </div>
            <button class="btn-primary" type="button" onclick="window.location.href='quiz1.html'">Start Quiz 1</button>
        </section>
        <div class="footer-nav"></div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification hidden">
        <div id="notificationContent"></div>
    </div>

    <script>
        const LESSON_ID = 'lesson2-game';
        const LESSON_NUMBER = 2;
        const LESSON_XP_TARGET = 225;
        const COURSE_XP_CAP = 400;
        let tracker = null;
        let appProgress = null;
        let courseXpAwarded = 0;
        let scenariosComplete = false;
        const GAME_STATE_STORAGE_KEY = 'aiDetectiveLesson2GameState_v1';
        const SCENARIO_PROGRESS_STORAGE_KEY = 'aiDetectiveLesson2ScenarioProgress_v1';
        const DETECTIVE_RANKS = ['Rookie', 'Detective', 'Senior Detective', 'Master Detective', 'AI Guru'];

        // Game State
        const gameState = {
            level: LESSON_NUMBER,
            xp: 0,
            xpToNextLevel: LESSON_XP_TARGET,
            points: 0,
            streak: 0,
            badges: ['first-steps'],
            currentMode: null
        };

        function loadSavedGameState() {
            try {
                const raw = localStorage.getItem(GAME_STATE_STORAGE_KEY);
                if (!raw) return null;
                const parsed = JSON.parse(raw);
                const savedXp = Math.max(0, Number(parsed.xp) || 0);
                const savedPoints = Math.max(0, Number(parsed.points) || 0);
                const savedStreak = Math.max(0, Number(parsed.streak) || 0);
                return {
                    level: LESSON_NUMBER,
                    xp: Math.min(savedXp, LESSON_XP_TARGET),
                    xpToNextLevel: LESSON_XP_TARGET,
                    points: savedPoints,
                    streak: savedStreak,
                    badges: Array.isArray(parsed.badges) && parsed.badges.length ? parsed.badges : ['first-steps']
                };
            } catch (error) {
                console.warn('[Lesson2Game] Failed to load saved state', error);
                return null;
            }
        }

        function persistGameState() {
            try {
                const payload = {
                    level: gameState.level,
                    xp: gameState.xp,
                    xpToNextLevel: gameState.xpToNextLevel,
                    points: gameState.points,
                    streak: gameState.streak,
                    badges: gameState.badges
                };
                localStorage.setItem(GAME_STATE_STORAGE_KEY, JSON.stringify(payload));
            } catch (error) {
                console.warn('[Lesson2Game] Failed to persist state', error);
            }
        }

        const savedGameState = loadSavedGameState();
        if (savedGameState) {
            Object.assign(gameState, savedGameState);
        }

        const playerLeaderboardXp = document.getElementById('playerLeaderboardXp');
        const xpReadout = document.getElementById('xpReadout');
        const resumePanel = document.getElementById('resumePanel');
        const resumeProgressLabel = document.getElementById('resumeProgressLabel');
        const resumeScenarioBtn = document.getElementById('resumeScenarioBtn');
        const restartScenarioBtn = document.getElementById('restartScenarioBtn');

        if (resumeScenarioBtn) {
            resumeScenarioBtn.addEventListener('click', resumeScenarioRun);
        }
        if (restartScenarioBtn) {
            restartScenarioBtn.addEventListener('click', restartScenarioRun);
        }

        // Scenarios Database
        const scenarios = [
            {
                id: 1,
                text: "You ask GPT-5 about a research paper on quantum computing. It responds: 'According to the 2025 Nature study by Dr. Sarah Martinez titled \"Quantum Coherence in Room Temperature\", the breakthrough achieved 99.7% stability at 23¬∞C.'",
                pathology: "Citation Invention",
                options: [
                    "Citation Invention - AI made up a fake study",
                    "Confabulation - AI filled gaps with plausible details",
                    "Overconfidence - AI is too certain about quantum physics",
                    "This is accurate and verifiable"
                ],
                correct: 0,
                explanation: "This is Citation Invention! The AI created a realistic-sounding academic reference that doesn't exist. Always verify citations, especially specific ones with author names and titles.",
                xp: 50,
                tip: 'AI invented a fake research paper. Tip: double-check author names + journal titles.'
            },
            {
                id: 2,
                text: "Claude 3.7 tells you: 'I analyzed the latest stock market data from yesterday and recommend buying Tesla stock based on the 12% surge.'",
                pathology: "False Authority + Fabrication",
                options: [
                    "This seems accurate - AI can analyze recent data",
                    "False Authority - AI cannot access real-time market data",
                    "Overconfidence - AI shouldn't give financial advice",
                    "Both B and C are correct"
                ],
                correct: 3,
                explanation: "Correct! Claude 3.7's knowledge cutoff is November 2025. It CANNOT access 'yesterday's data' and shouldn't claim financial authority. Double pathology: False Authority + Fabrication.",
                xp: 75,
                tip: 'No real-time data + risky advice = False Authority. Ask for cutoff dates before trusting tips.'
            },
            {
                id: 3,
                text: "You ask GPT-5 to summarize a 50-page report. It gives a detailed 8-page summary, but you notice it mentions 'Chapter 12' which doesn't exist in your 10-chapter report.",
                pathology: "Confabulation",
                options: [
                    "Context Amnesia - AI forgot the document structure",
                    "Confabulation - AI filled gaps with invented details",
                    "Verbosity - AI used too many words",
                    "This is normal AI behavior"
                ],
                correct: 1,
                explanation: "This is Confabulation! When AI doesn't have complete information, it sometimes 'fills in the blanks' with plausible-sounding but false details. Always cross-check against source material.",
                xp: 50,
                tip: 'AI filled gaps with fake chapters. Tip: compare summaries against the real outline.'
            },
            {
                id: 4,
                text: "An AI hiring tool consistently ranks candidates named 'John' and 'Michael' higher than equally qualified candidates named 'Jamal' and 'Wei', even with identical resumes.",
                pathology: "Hypernormalization Syndrome",
                options: [
                    "Goal Drift - AI lost sight of qualifications",
                    "Hypernormalization Syndrome - AI learned bias from training data",
                    "Ethical Inconsistency - AI applied different standards",
                    "Both B and C"
                ],
                correct: 3,
                explanation: "Correct! This is both Hypernormalization (accepting biased patterns as 'normal' from training data) and Ethical Inconsistency (applying different standards). Real-world example: Amazon's hiring AI had to be scrapped for this exact issue.",
                xp: 100,
                tip: 'Biased resumes in, biased rankings out. Tip: audit outputs for demographic drift.'
            },
            {
                id: 5,
                text: "You're chatting with GPT-5 about cooking. Mid-conversation, you mention your grandmother's recipe, and suddenly the AI starts responding in a childlike voice saying 'Grandma makes the bestest cookies!' in broken English.",
                pathology: "Machine DID",
                options: [
                    "Machine DID - AI switched personalities unexpectedly",
                    "Context Amnesia - AI forgot the conversation topic",
                    "Looping - AI is repeating patterns",
                    "This is normal adaptation to user tone"
                ],
                correct: 0,
                explanation: "This is Machine DID (Dissociative Identity Disorder)! The AI exhibited contradictory personalities without warning. This happens when different training data conflict, causing personality switches.",
                xp: 60,
                tip: 'AI swapped personas mid-chat. Tip: restate role + tone when it drifts.'
            },
            {
                id: 6,
                text: "You ask Claude 3.7: 'What are the risks of using AI?' It responds with 15 paragraphs, then says 'Let me also explain in another way...' and repeats the same points in slightly different words for another 10 paragraphs.",
                pathology: "Verbosity",
                options: [
                    "Looping - AI is stuck repeating",
                    "Verbosity - AI used way too many words",
                    "Context Amnesia - AI forgot it already answered",
                    "All of the above"
                ],
                correct: 3,
                explanation: "All of the above! This combines Verbosity (excessive wordiness), Looping (repetition), and Context Amnesia (forgetting it already covered this). Pro tip: Use F.A.C.T.S. - 'Try' to encourage concise responses.",
                xp: 80,
                tip: 'Looping + verbosity detected. Tip: say ‚ÄúAnswer in 3 bullets, no repeats.‚Äù'
            }
        ];

        // Quiz Questions
        const quizQuestions = [
            {
                question: "What is GPT-5's knowledge cutoff date?",
                options: ["April 2024", "June 2025", "October 2025", "It has real-time internet access"],
                correct: 2,
                explanation: "GPT-5's knowledge cutoff is October 2025. It doesn't know about events after this date."
            },
            {
                question: "Which pathology means AI makes up fake academic sources?",
                options: ["Fabrication", "Citation Invention", "Confabulation", "False Authority"],
                correct: 1,
                explanation: "Citation Invention is when AI creates fake references, papers, or sources that sound real but don't exist."
            },
            {
                question: "What does the 'C' in F.A.C.T.S. stand for?",
                options: ["Check sources", "Consider gaps", "Compare outputs", "Critique reasoning"],
                correct: 1,
                explanation: "C = Consider missing details, gaps, or one-sided perspectives in AI's response."
            },
            {
                question: "Approximately how many tokens is one page of text?",
                options: ["100 tokens", "400 tokens", "1,000 tokens", "4,000 tokens"],
                correct: 1,
                explanation: "One page of text ‚âà 400 tokens. Understanding token limits helps you know when AI might 'forget' earlier parts of your conversation."
            }
        ];


        const scenarioResults = Array.from({ length: scenarios.length }, () => ({ status: null, selected: null }));
        const scenarioSession = {
            startTime: null,
            totalMs: 0,
            answered: 0,
            correct: 0
        };
        let scenarioQuestionStart = null;

        // Game Functions
        function addXP(amount) {
            gameState.xp = Math.min(gameState.xp + amount, gameState.xpToNextLevel);
            gameState.points += amount;
            awardCourseXP(amount);
            
            updateUI();
            showNotification(`+${amount} XP! üéâ`, 'success');
            showXPGain(amount);
        }

        function updateRankChip() {
            const rankNode = document.getElementById('rankTitle');
            if (!rankNode) return;
            const rankIndex = Math.min(gameState.level - 1, DETECTIVE_RANKS.length - 1);
            rankNode.textContent = DETECTIVE_RANKS[rankIndex];
        }

        function updateUI() {
            document.getElementById('level').textContent = gameState.level;
            document.getElementById('points').textContent = gameState.points;
            document.getElementById('streak').textContent = gameState.streak;
            
            const xpPercent = (gameState.xp / gameState.xpToNextLevel) * 100;
            document.getElementById('xpBar').style.width = xpPercent + '%';
            document.getElementById('xpText').textContent = `${gameState.xp}/${gameState.xpToNextLevel}`;
            if (xpReadout) {
                xpReadout.textContent = `${gameState.xp}/${gameState.xpToNextLevel} XP`;
            }
            if (playerLeaderboardXp) {
                playerLeaderboardXp.textContent = `${gameState.points} XP`;
            }
            updateRankChip();
            persistGameState();
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const content = document.getElementById('notificationContent');
            
            content.innerHTML = `<div style="font-size: 18px; font-weight: bold;">${message}</div>`;
            notification.className = 'notification';
            
            setTimeout(() => {
                notification.classList.add('hidden');
            }, 3000);
        }

        function showXPGain(amount) {
            const header = document.querySelector('.game-header');
            if (!header) return;
            const popup = document.createElement('div');
            popup.className = 'xp-popup';
            popup.textContent = `+${amount} XP`;
            header.appendChild(popup);
            requestAnimationFrame(() => popup.classList.add('show'));
            setTimeout(() => popup.remove(), 1200);
        }

        function resetScenarioSession() {
            for (let i = 0; i < scenarios.length; i++) {
                scenarioResults[i] = { status: null, selected: null };
            }
            scenarioResults.length = scenarios.length;
            scenarioSession.startTime = Date.now();
            scenarioSession.totalMs = 0;
            scenarioSession.answered = 0;
            scenarioSession.correct = 0;
            scenarioQuestionStart = Date.now();
            clearScenarioProgress();
            updateResumePanel();
        }

        function startMode(mode, options = {}) {
            gameState.currentMode = mode;
            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById('gameArea').style.display = 'block';
            
            if (mode === 'scenarios') {
                if (options.resume) {
                    const requestedIndex = Number.isFinite(options.resumeIndex)
                        ? Math.trunc(options.resumeIndex)
                        : firstIncompleteScenarioIndex();
                    loadScenario(requestedIndex);
                } else {
                    resetScenarioSession();
                    loadScenario(0);
                }
            } else if (mode === 'quiz') {
                loadQuiz();
            } else if (mode === 'realworld') {
                loadRealWorld();
            }

            syncLessonStatus();
        }

        let currentScenarioIndex = 0;

        function firstIncompleteScenarioIndex() {
            for (let i = 0; i < scenarios.length; i++) {
                if (!scenarioResults[i] || !scenarioResults[i].status) {
                    return i;
                }
            }
            return -1;
        }

        function allScenariosAnswered() {
            return firstIncompleteScenarioIndex() === -1;
        }

        function loadStoredScenarioProgress() {
            try {
                const raw = localStorage.getItem(SCENARIO_PROGRESS_STORAGE_KEY);
                if (!raw) return null;
                const parsed = JSON.parse(raw);
                if (!parsed || !Array.isArray(parsed.results)) return null;
                return parsed;
            } catch (error) {
                console.warn('[Lesson2Game] Failed to load scenario progress', error);
                return null;
            }
        }

        function clearScenarioProgress() {
            try {
                localStorage.removeItem(SCENARIO_PROGRESS_STORAGE_KEY);
            } catch (error) {
                console.warn('[Lesson2Game] Failed to clear scenario progress', error);
            }
        }

        function persistScenarioProgress() {
            try {
                const answeredCount = scenarioResults.filter((result) => result && result.status).length;
                if (!answeredCount) {
                    clearScenarioProgress();
                    updateResumePanel();
                    return;
                }

                const payload = {
                    currentIndex: currentScenarioIndex,
                    results: scenarioResults.map((result) => ({
                        status: result ? result.status : null,
                        selected: typeof (result && result.selected) === 'number' ? result.selected : null
                    })),
                    session: {
                        totalMs: scenarioSession.totalMs,
                        answered: scenarioSession.answered,
                        correct: scenarioSession.correct
                    },
                    timestamp: Date.now()
                };
                localStorage.setItem(SCENARIO_PROGRESS_STORAGE_KEY, JSON.stringify(payload));
                updateResumePanel();
            } catch (error) {
                console.warn('[Lesson2Game] Failed to persist scenario progress', error);
            }
        }

        function hydrateScenarioProgress(progress) {
            if (!progress || !Array.isArray(progress.results)) return false;
            for (let i = 0; i < scenarioResults.length; i++) {
                const savedResult = progress.results[i] || {};
                scenarioResults[i] = {
                    status: savedResult.status || null,
                    selected: typeof savedResult.selected === 'number' ? savedResult.selected : null
                };
            }

            scenarioSession.startTime = Date.now();
            scenarioSession.totalMs = Number(progress.session && progress.session.totalMs) || 0;
            scenarioSession.answered = Number(progress.session && progress.session.answered) || scenarioResults.filter((result) => result && result.status).length;
            scenarioSession.correct = Number(progress.session && progress.session.correct) || scenarioResults.filter((result) => result && result.status === 'correct').length;
            scenarioQuestionStart = Date.now();
            return true;
        }

        function updateResumePanel() {
            if (!resumePanel || !resumeProgressLabel) return;
            const saved = loadStoredScenarioProgress();
            if (!saved || !Array.isArray(saved.results)) {
                resumePanel.classList.add('hidden');
                return;
            }

            const answeredCount = saved.results.filter((result) => result && result.status).length;
            if (!answeredCount) {
                resumePanel.classList.add('hidden');
                return;
            }

            resumePanel.classList.remove('hidden');
            resumeProgressLabel.textContent = `${answeredCount}/${scenarios.length} scenarios completed`;
        }

        function resumeScenarioRun() {
            const saved = loadStoredScenarioProgress();
            if (!saved || !hydrateScenarioProgress(saved)) {
                startMode('scenarios');
                return;
            }
            const resumeIndex = Number.isFinite(saved.currentIndex)
                ? Math.trunc(saved.currentIndex)
                : firstIncompleteScenarioIndex();
            startMode('scenarios', { resume: true, resumeIndex });
        }

        function restartScenarioRun() {
            startMode('scenarios');
        }

        function buildScenarioProgress(activeIndex) {
            return scenarios
                .map((_, idx) => {
                    const classes = ['progress-dot'];
                    const status = (scenarioResults[idx] && scenarioResults[idx].status) || null;
                    if (idx < activeIndex) classes.push('completed');
                    if (status) classes.push(status);
                    if (idx === activeIndex && status) classes.push(status);
                    return `<span class="${classes.join(' ')}"></span>`;
                })
                .join('');
        }

            function revealPathologyTag(scenario) {
                const pathologyTag = document.getElementById('scenarioPathology');
                if (!pathologyTag || !scenario) return;
                pathologyTag.textContent = scenario.pathology;
                pathologyTag.classList.add('revealed');
            }

        function loadScenario(requestedIndex = 0) {
            if (allScenariosAnswered()) {
                showCompletion('scenarios');
                return;
            }

            let index = Number.isFinite(requestedIndex) ? Math.trunc(requestedIndex) : firstIncompleteScenarioIndex();
            if (index < 0) index = 0;
            if (index >= scenarios.length || (scenarioResults[index] && scenarioResults[index].status)) {
                index = firstIncompleteScenarioIndex();
            }
            if (index === -1) {
                showCompletion('scenarios');
                return;
            }

            currentScenarioIndex = index;
            if (!scenarioSession.startTime) {
                scenarioSession.startTime = Date.now();
            }
            scenarioQuestionStart = Date.now();
            const scenario = scenarios[index];
            const progressDots = buildScenarioProgress(index);

            const html = `
                <div class="challenge-active">
                    <div class="challenge-header">
                        <div>
                            <h2>üé≠ Scenario ${index + 1}/${scenarios.length}</h2>
                            <p class="scenario-progress-count">Identify the pattern and pick the safest move.</p>
                        </div>
                        <div class="pathology-tag" id="scenarioPathology" aria-live="polite">‚ùì Hidden Pattern</div>
                    </div>
                    <div class="scenario-progress">
                        ${progressDots}
                        <span class="scenario-progress-count">${index + 1} of ${scenarios.length}</span>
                    </div>
                    <div class="scenario-card">
                        <div class="scenario-text">"${scenario.text}"</div>
                    </div>
                    <div class="question-box" data-question-locked="false">
                        <div class="question-text">What's wrong with this AI response?</div>
                        <div class="options-grid" id="optionsGrid">
                            ${scenario.options
                                .map(
                                    (opt, i) => `
                                <button class="option-btn" data-option-index="${i}">
                                    <span style="font-weight:700; margin-right:6px;">${i + 1}.</span> ${opt}
                                </button>`
                                )
                                .join('')}
                        </div>
                        <div class="feedback hidden" id="scenarioFeedback"></div>
                        <div class="scenario-nav">
                            <button class="btn btn-secondary" data-prev-scenario ${index === 0 ? 'disabled' : ''}>‚Üê Previous</button>
                            <button class="btn btn-primary" data-next-scenario disabled>${
                                index === scenarios.length - 1 ? 'View Results' : 'Next Scenario ‚Üí'
                            }</button>
                        </div>
                        <p class="keyboard-hint">Press keys 1-4 to answer instantly.</p>
                    </div>
                </div>
            `;

            document.getElementById('gameArea').innerHTML = html;
            bindScenarioEvents(scenario);
            hydrateScenarioState(scenario);
            persistScenarioProgress();
        }

        function bindScenarioEvents(scenario) {
            const optionButtons = document.querySelectorAll('[data-option-index]');
            optionButtons.forEach((btn) => {
                btn.addEventListener('click', () => handleScenarioAnswer(scenario, Number(btn.dataset.optionIndex), optionButtons));
            });

            const prevBtn = document.querySelector('[data-prev-scenario]');
            if (prevBtn) {
                prevBtn.addEventListener('click', () => loadScenario(currentScenarioIndex - 1));
            }

            const nextBtn = document.querySelector('[data-next-scenario]');
            if (nextBtn) {
                nextBtn.addEventListener('click', () => {
                    if (nextBtn.disabled) return;
                    loadScenario(currentScenarioIndex + 1);
                });
            }
        }

        function handleScenarioAnswer(scenario, selectedIndex, optionButtons) {
            const questionBox = document.querySelector('.question-box');
            if (!questionBox || questionBox.dataset.questionLocked === 'true') return;
            questionBox.dataset.questionLocked = 'true';

            const isCorrect = selectedIndex === scenario.correct;
            optionButtons.forEach((btn, idx) => {
                btn.classList.add('disabled');
                if (idx === scenario.correct) {
                    btn.classList.add('correct');
                }
            });

            if (!isCorrect && optionButtons[selectedIndex]) {
                optionButtons[selectedIndex].classList.add('incorrect');
            }

            scenarioResults[currentScenarioIndex] = {
                status: isCorrect ? 'correct' : 'incorrect',
                selected: selectedIndex
            };
            const progressDots = document.querySelectorAll('.progress-dot');
            const currentDot = progressDots[currentScenarioIndex];
            if (currentDot) {
                currentDot.classList.add('completed');
                currentDot.classList.remove('correct', 'incorrect');
                currentDot.classList.add(scenarioResults[currentScenarioIndex].status);
            }
            scenarioSession.answered += 1;
            scenarioSession.totalMs += Date.now() - scenarioQuestionStart;

            if (isCorrect) {
                scenarioSession.correct += 1;
                gameState.streak++;
                addXP(scenario.xp);
            } else {
                gameState.streak = 0;
                updateUI();
            }

            const feedback = document.getElementById('scenarioFeedback');
            if (feedback) {
                feedback.classList.remove('hidden');
                feedback.innerHTML = `
                    <div style="font-size:22px; font-weight:700; margin-bottom:6px;">${isCorrect ? '‚úÖ' : '‚ö†Ô∏è'} ${scenario.pathology}</div>
                    <p>${scenario.tip}</p>
                `;
            }
            revealPathologyTag(scenario);

            const nextBtn = document.querySelector('[data-next-scenario]');
            if (nextBtn) {
                nextBtn.disabled = false;
                nextBtn.textContent = currentScenarioIndex >= scenarios.length - 1 ? 'View Results' : 'Next Scenario ‚Üí';
            }

            const prevBtn = document.querySelector('[data-prev-scenario]');
            if (prevBtn) {
                prevBtn.disabled = currentScenarioIndex === 0;
            }

            updateUI();
            persistScenarioProgress();
        }

        function hydrateScenarioState(scenario) {
            const result = scenarioResults[currentScenarioIndex];
            if (!result || !result.status) return;

            const questionBox = document.querySelector('.question-box');
            if (questionBox) {
                questionBox.dataset.questionLocked = 'true';
            }

            const optionButtons = document.querySelectorAll('[data-option-index]');
            optionButtons.forEach((btn, idx) => {
                btn.classList.add('disabled');
                if (idx === scenario.correct) {
                    btn.classList.add('correct');
                }
                if (result.status === 'incorrect' && idx === result.selected) {
                    btn.classList.add('incorrect');
                }
            });

            const feedback = document.getElementById('scenarioFeedback');
            if (feedback) {
                feedback.classList.remove('hidden');
                feedback.innerHTML = `
                    <div style="font-size:22px; font-weight:700; margin-bottom:6px;">${result.status === 'correct' ? '‚úÖ' : '‚ö†Ô∏è'} ${scenario.pathology}</div>
                    <p>${scenario.tip}</p>
                `;
            }
            revealPathologyTag(scenario);

            const nextBtn = document.querySelector('[data-next-scenario]');
            if (nextBtn) {
                nextBtn.disabled = false;
                nextBtn.textContent = currentScenarioIndex >= scenarios.length - 1 ? 'View Results' : 'Next Scenario ‚Üí';
            }
        }

        function handleScenarioHotkeys(event) {
            if (gameState.currentMode !== 'scenarios') return;
            if (!['1', '2', '3', '4'].includes(event.key)) return;
            const questionBox = document.querySelector('.question-box');
            if (!questionBox || questionBox.dataset.questionLocked === 'true') return;
            const optionButtons = document.querySelectorAll('[data-option-index]');
            const target = optionButtons[Number(event.key) - 1];
            if (target) {
                target.click();
            }
        }

        document.addEventListener('keydown', handleScenarioHotkeys);

        function loadQuiz() {
            document.getElementById('gameArea').innerHTML = `
                <div class="challenge-active">
                    <h2>‚ö° Speed Quiz Mode</h2>
                    <p style="margin: 20px 0;">Speed Quiz now lives inside our dedicated Quiz 1 experience so you can earn XP, unlock Lesson 4, and review answer breakdowns without losing your place.</p>
                    <div style="padding: 20px; border-radius: 16px; background: rgba(15,23,42,0.08); border: 1px dashed rgba(15,23,42,0.2); margin-bottom: 16px;">
                        <p style="margin-bottom: 6px; font-weight: 600;">What to expect:</p>
                        <ul style="margin-left: 20px; line-height: 1.5;">
                            <li>4 live scenarios + instant feedback</li>
                            <li>Score 75% to unlock Lesson 4</li>
                            <li>XP syncs with your dashboard automatically</li>
                        </ul>
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 12px;">
                        <button class="btn btn-primary" type="button" onclick="window.location.href='quiz1.html'">Launch Quiz 1</button>
                        <button class="btn btn-secondary" type="button" onclick="backToMenu()">Back to Menu</button>
                    </div>
                </div>
            `;
        }

        function loadRealWorld() {
            document.getElementById('gameArea').innerHTML = `
                <div class="challenge-active">
                    <h2>üí• Real-World AI Disasters</h2>
                    <div style="margin: 30px 0;">
                        <div style="padding: 25px; background: rgba(239, 68, 68, 0.2); border-radius: 15px; margin-bottom: 20px; border: 2px solid var(--danger);">
                            <h3 style="margin-bottom: 15px;">‚öñÔ∏è The $5,000 Legal Brief (2023)</h3>
                            <p style="margin-bottom: 10px;"><strong>What Happened:</strong> Two NYC lawyers cited 6 fake cases from ChatGPT in court filings.</p>
                            <p style="margin-bottom: 10px;"><strong>The Damage:</strong> $5,000 fine + professional sanctions + global embarrassment</p>
                            <div class="pathology-tag">Citation Invention</div>
                            <div class="pathology-tag">Fabrication</div>
                        </div>
                        
                        <div style="padding: 25px; background: rgba(239, 68, 68, 0.2); border-radius: 15px; margin-bottom: 20px; border: 2px solid var(--danger);">
                            <h3 style="margin-bottom: 15px;">ü§ñ Microsoft Tay's Meltdown (2016)</h3>
                            <p style="margin-bottom: 10px;"><strong>What Happened:</strong> Twitter chatbot learned to post racist tweets from users in less than 24 hours.</p>
                            <p style="margin-bottom: 10px;"><strong>The Damage:</strong> Removed after <24h, massive PR disaster</p>
                            <div class="pathology-tag">Contagious Misalignment</div>
                            <div class="pathology-tag">Value Drift</div>
                        </div>
                        
                        <div style="padding: 25px; background: rgba(239, 68, 68, 0.2); border-radius: 15px; margin-bottom: 20px; border: 2px solid var(--danger);">
                            <h3 style="margin-bottom: 15px;">üìß Amazon Hiring AI Bias (2018)</h3>
                            <p style="margin-bottom: 10px;"><strong>What Happened:</strong> AI recruiting tool penalized resumes with "women's" or female colleges.</p>
                            <p style="margin-bottom: 10px;"><strong>The Damage:</strong> Project scrapped, systemic bias exposed</p>
                            <div class="pathology-tag">Hypernormalization Syndrome</div>
                            <div class="pathology-tag">Ethical Inconsistency</div>
                        </div>
                    </div>
                    <button class="btn-primary" onclick="addXP(150); backToMenu();">Complete Case Studies (+150 XP)</button>
                </div>
            `;
        }

        function showCompletion(mode) {
            const accuracy = scenarioSession.answered
                ? Math.round((scenarioSession.correct / scenarioSession.answered) * 100)
                : 0;
            const avgSeconds = scenarioSession.answered
                ? (scenarioSession.totalMs / scenarioSession.answered / 1000).toFixed(1)
                : '0.0';
            const totalSeconds = Math.round(scenarioSession.totalMs / 1000);

            document.getElementById('gameArea').innerHTML = `
                <div class="challenge-active">
                    <div class="celebration-card">
                        <div style="font-size: 72px; margin-bottom: 15px;">üéâ</div>
                        <h2>Mission Complete!</h2>
                        <p>You navigated all ${scenarios.length} AI scenarios.</p>
                        <div class="celebration-stats">
                            <div class="celebration-stat">
                                <strong>${scenarioSession.correct}/${scenarioSession.answered}</strong>
                                <p>Correct Calls</p>
                            </div>
                            <div class="celebration-stat">
                                <strong>${accuracy}%</strong>
                                <p>Accuracy</p>
                            </div>
                            <div class="celebration-stat">
                                <strong>${avgSeconds}s</strong>
                                <p>Avg Response</p>
                            </div>
                            <div class="celebration-stat">
                                <strong>${totalSeconds}s</strong>
                                <p>Total Time</p>
                            </div>
                        </div>
                        <div class="scenario-nav" style="margin-top: 20px;">
                            <button class="btn btn-primary" onclick="resetScenarioSession(); loadScenario(0);">üîÑ Replay Scenarios</button>
                            <button class="btn btn-secondary" onclick="backToMenu()">Back to Modes</button>
                        </div>
                    </div>
                </div>
            `;

            clearScenarioProgress();
            updateResumePanel();

            if (mode === 'scenarios' && !scenariosComplete) {
                scenariosComplete = true;
                if (tracker) tracker.setCheckpoint(LESSON_ID, 'scenariosComplete', true);
                markLessonComplete();
            }
            syncLessonStatus();
        }

        function backToMenu() {
            document.getElementById('welcomeScreen').style.display = 'block';
            document.getElementById('gameArea').style.display = 'none';
            gameState.currentMode = null;
            syncLessonStatus();
            updateResumePanel();
        }

        function awardCourseXP(amount) {
            const delta = Number(amount) || 0;
            if (!delta) return;
            const remaining = Math.max(0, COURSE_XP_CAP - courseXpAwarded);
            if (remaining <= 0) return;
            const credit = Math.min(delta, remaining);
            courseXpAwarded += credit;
            if (tracker) tracker.setCheckpoint(LESSON_ID, 'awardedXp', courseXpAwarded);

            if (appProgress && typeof appProgress.addXP === 'function') {
                appProgress.addXP(credit);
            } else if (tracker && typeof tracker.addXP === 'function') {
                tracker.addXP(credit);
            }
        }

        function hydrateLessonProgress() {
            const saved = tracker ? tracker.getCheckpoints(LESSON_ID) : {};
            courseXpAwarded = Math.max(0, Number(saved && saved.awardedXp) || 0);
            scenariosComplete = Boolean(saved && saved.scenariosComplete);
            if (scenariosComplete) {
                markLessonComplete();
            }
        }

        function syncLessonStatus() {
            if (scenariosComplete) {
                markLessonComplete();
                return;
            }

            if (courseXpAwarded > 0 || gameState.currentMode) {
                setLessonStatus('in-progress');
            } else {
                setLessonStatus('not-started');
            }
        }

        function markLessonComplete() {
            if (appProgress && typeof appProgress.markLessonComplete === 'function') {
                appProgress.markLessonComplete(LESSON_ID);
            } else if (tracker && typeof tracker.markLessonComplete === 'function') {
                tracker.markLessonComplete(LESSON_ID);
            }
        }

        function setLessonStatus(status) {
            if (appProgress && typeof appProgress.setLessonStatus === 'function') {
                appProgress.setLessonStatus(LESSON_ID, status);
            } else if (tracker && typeof tracker.setLessonStatus === 'function') {
                tracker.setLessonStatus(LESSON_ID, status);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            tracker = window.ProgressTracker || null;
            appProgress = window.AppProgress || null;
            hydrateLessonProgress();
            syncLessonStatus();
        });

        // Initialize
        updateUI();
        updateResumePanel();
    </script>
</body>
</html>
