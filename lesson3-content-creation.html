<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self'; connect-src 'self';">
    <title>Lesson 3: AI Content Creation & Ethics &#127912;</title>

    <link rel="stylesheet" href="styles/shared.css">
    <script defer src="scripts/nav.js"></script>
    <script defer src="scripts/progress.js"></script>
    <style>
        .lesson-shell { display: flex; flex-direction: column; gap: 24px; }
        .content-grid { display: flex; flex-direction: column; gap: 24px; }
        .challenge-section { margin-bottom: 24px; }
        .challenge-title { font-size: 34px; margin-bottom: 10px; }
        .challenge-desc { color: var(--color-muted); margin-bottom: 20px; }
        .mission-board { background: rgba(255, 255, 255, 0.08); border: 1px solid rgba(255, 255, 255, 0.15); border-radius: var(--radius-lg); padding: 18px; margin-bottom: 24px; }
        .mission-board-header { display: flex; justify-content: space-between; flex-wrap: wrap; gap: 12px; align-items: flex-start; }
        .mission-board-header h3 { margin: 0; font-size: 20px; }
        .mission-board-hint { font-size: 14px; color: rgba(255, 255, 255, 0.7); margin-top: 4px; }
        .mission-board-progress { font-size: 14px; font-weight: 600; color: var(--color-gold); }
        .mission-chip-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 12px; margin-top: 16px; }
        .mission-chip { border: 1px solid rgba(255, 255, 255, 0.2); border-radius: var(--radius-md); padding: 14px; display: flex; align-items: center; gap: 12px; background: rgba(0, 0, 0, 0.25); color: inherit; cursor: pointer; transition: transform var(--transition-base), border-color var(--transition-base); width: 100%; text-align: left; }
        .mission-chip:hover { transform: translateY(-3px); }
        .mission-chip.completed { border-color: rgba(16, 185, 129, 0.8); background: rgba(16, 185, 129, 0.18); }
        .mission-chip.in-progress { border-color: rgba(59, 130, 246, 0.8); }
        .mission-chip.not-started { opacity: 0.8; }
        .mission-index { width: 32px; height: 32px; border-radius: 50%; background: rgba(255, 255, 255, 0.15); display: grid; place-items: center; font-weight: bold; }
        .mission-chip.completed .mission-index { background: rgba(16, 185, 129, 0.2); }
        .mission-chip.in-progress .mission-index { background: rgba(59, 130, 246, 0.2); }
        .mission-body { flex: 1; display: flex; flex-direction: column; gap: 2px; }
        .mission-title { font-size: 15px; font-weight: 600; }
        .mission-progress { font-size: 12px; color: rgba(255, 255, 255, 0.8); }
        .mission-status-icon { font-size: 16px; }
        .mission-return { margin-top: 12px; background: rgba(255, 255, 255, 0.08); border: 1px solid rgba(255, 255, 255, 0.15); color: inherit; padding: 10px 14px; border-radius: 999px; font-size: 12px; cursor: pointer; }
        .mission-return:hover { background: rgba(255, 255, 255, 0.15); }
        .next-lock-hint { font-size: 13px; margin-top: 8px; color: rgba(255, 255, 255, 0.7); text-align: center; }
        .next-lock-hint.unlocked { color: #10B981; font-weight: 600; }
        .tool-showcase { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; }
        .tool-card { min-height: 160px; }
        .activity-card { display: flex; gap: 18px; padding: 22px; border-radius: var(--radius-lg); background: rgba(255, 255, 255, 0.08); border: 1px solid rgba(255, 255, 255, 0.15); transition: transform var(--transition-base); }
        .activity-card:hover { transform: translateY(-3px); }
        .activity-icon { width: 60px; height: 60px; border-radius: var(--radius-md); background: rgba(255, 255, 255, 0.12); display: grid; place-items: center; font-size: 30px; }
        .activity-title { font-size: 20px; margin-bottom: 6px; }
        .activity-desc { color: var(--color-muted); font-size: 15px; }
        .activity-reward { margin-top: 12px; color: var(--color-gold); font-weight: 600; }
        .prompt-builder { background: rgba(0, 0, 0, 0.35); border-radius: var(--radius-lg); padding: 24px; border: 1px solid rgba(255, 255, 255, 0.15); }
        .prompt-tips { margin-bottom: 12px; }
        .quiz-options { display: grid; gap: 12px; }
        .quiz-option { padding: 18px; border-radius: var(--radius-md); background: rgba(255, 255, 255, 0.08); border: 1px solid rgba(255, 255, 255, 0.15); cursor: pointer; transition: background var(--transition-base); }
        .quiz-option.correct { border-color: var(--color-accent); background: rgba(16, 185, 129, 0.2); }
        .quiz-option.incorrect { border-color: var(--color-danger); background: rgba(248, 113, 113, 0.22); }
        .notification { position: fixed; bottom: 24px; right: 24px; background: rgba(0, 0, 0, 0.85); padding: 16px 22px; border-radius: var(--radius-md); display: none; }
        .notification.show { display: block; }
        @media (max-width: 768px) { .challenge-title { font-size: 26px; } }
    </style>
    <script defer src="scripts/shared.js"></script>

</head>
<body data-lesson-id="lesson3">
    <div class="container lesson-shell">
        <div class="header">
            <div class="logo">
                üé® Lesson 3: AI Content Creation
            </div>
            <div class="breadcrumb"></div>
            <div class="stats">
                <div>
                    <div class="stat-label">XP</div>
                    <div class="xp-bar">
                        <div class="xp-fill" id="xpBar">
                            <span id="xpText">0/200</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="content-grid">
            <div class="main-panel">
                <div class="mode-selector">
                    <button class="mode-btn" id="gameBtn">
                        üéÆ Game Mode
                    </button>
                    <button class="mode-btn active" id="presentBtn">
                        üìö Learn
                    </button>
                </div>

                <!-- Game Mode Content -->
                <div id="gameMode" class="hidden">
                    <div class="challenge-section">
                        <h1 class="challenge-title">üé® Master AI Content Creation</h1>
                        <p class="challenge-desc">
                            Welcome to the creative side of AI! In this lesson, you'll learn to create stunning images, videos, and text with AI tools while understanding the ethical implications. Let's turn you into an AI artist! üöÄ
                        </p>

                        <div id="missionHubTop"></div>
                        <div class="mission-board">
                            <div class="mission-board-header">
                                <div>
                                    <h3>Mission Tracker</h3>
                                    <p class="mission-board-hint">Tap a badge to jump to each mini-game.</p>
                                </div>
                                <div class="mission-board-progress" id="missionBoardSummary">0/4 missions complete</div>
                            </div>
                            <div class="mission-chip-list" id="missionTracker"></div>
                        </div>

                        <div class="ethics-warning">
                            <div class="ethics-title">‚ö†Ô∏è Ethics First!</div>
                            <p>Before we create, remember: With great AI power comes great responsibility. Always consider copyright, consent, deepfakes, and misinformation.</p>
                        </div>

                        <h3 style="margin: 30px 0 20px 0;">üõ†Ô∏è Your Creative Arsenal</h3>
                        <div class="tool-showcase">
                            <div class="tool-card">
                                <div style="font-size: 40px; margin-bottom: 10px;">üñºÔ∏è</div>
                                <div style="font-weight: bold;">DALL-E 3</div>
                                <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">Via ChatGPT Plus</div>
                            </div>
                            <div class="tool-card">
                                <div style="font-size: 40px; margin-bottom: 10px;">üé®</div>
                                <div style="font-weight: bold;">Midjourney</div>
                                <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">Discord-based</div>
                            </div>
                            <div class="tool-card">
                                <div style="font-size: 40px; margin-bottom: 10px;">üé¨</div>
                                <div style="font-weight: bold;">Runway</div>
                                <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">Video Generation</div>
                            </div>
                            <div class="tool-card">
                                <div style="font-size: 40px; margin-bottom: 10px;">üé≠</div>
                                <div style="font-weight: bold;">Stable Diffusion</div>
                                <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">Open Source</div>
                            </div>
                            <div class="tool-card">
                                <div style="font-size: 40px; margin-bottom: 10px;">üéµ</div>
                                <div style="font-weight: bold;">Suno AI</div>
                                <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">Music Creation</div>
                            </div>
                            <div class="tool-card">
                                <div style="font-size: 40px; margin-bottom: 10px;">üó£Ô∏è</div>
                                <div style="font-weight: bold;">ElevenLabs</div>
                                <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">Voice Cloning</div>
                            </div>
                        </div>

                        <h3 style="margin: 40px 0 20px 0;" id="missionImage">üéØ Challenge 1: Image Creation Mastery</h3>
                        <div class="activity-card" onclick="startActivity('image')">
                            <div class="activity-icon">üñºÔ∏è</div>
                            <div class="activity-title">Create 3 Different AI Images</div>
                            <div class="activity-desc">
                                Use ChatGPT's DALL-E 3 or another tool to create:
                                <ul style="margin: 10px 0 10px 20px;">
                                    <li>A realistic photo</li>
                                    <li>An artistic illustration</li>
                                    <li>An abstract concept visualization</li>
                                </ul>
                            </div>
                            <div class="activity-reward">+75 XP | Unlock "AI Artist" badge</div>
                        </div>
                        <button class="mission-return" type="button" data-scroll-top="missions">‚Üë Back to mission tracker</button>

                        <h3 style="margin: 30px 0 20px 0;" id="missionVideo">üé¨ Challenge 2: Video Generation</h3>
                        <div class="activity-card" onclick="startActivity('video')">
                            <div class="activity-icon">üé¨</div>
                            <div class="activity-title">Create a 5-Second AI Video</div>
                            <div class="activity-desc">
                                Use Runway Gen-3 or similar to create a short video from a text prompt or image. Focus on smooth motion and clear narrative.
                            </div>
                            <div class="activity-reward">+100 XP | Unlock "Motion Master" badge</div>
                        </div>
                        <button class="mission-return" type="button" data-scroll-top="missions">‚Üë Back to mission tracker</button>

                        <h3 style="margin: 30px 0 20px 0;" id="missionQuiz">‚öñÔ∏è Challenge 3: Ethics Quiz</h3>
                        <div id="ethicsQuiz" class="challenge-section" style="background: rgba(255, 68, 68, 0.1);">
                            <p style="margin-bottom: 20px;">Test your understanding of AI content creation ethics:</p>
                            <div id="quizContainer"></div>
                        </div>
                        <button class="mission-return" type="button" data-scroll-top="missions">‚Üë Back to mission tracker</button>

                        <h3 style="margin: 30px 0 20px 0;" id="missionPrompt">üéì Challenge 4: Prompt Engineering</h3>
                        <div class="prompt-builder">
                            <p style="margin-bottom: 15px; font-weight: bold;">Build the perfect image prompt:</p>
                            <textarea class="prompt-input" id="promptInput" placeholder="Example: A serene mountain landscape at sunset, with snow-capped peaks reflected in a crystal-clear lake, painted in the style of Bob Ross, warm colors, peaceful atmosphere, 8K quality"></textarea>
                            
                            <div class="prompt-tips">
                                <div style="font-weight: bold; margin: 15px 0 10px 0;">üí° Prompt Formula:</div>
                                <div class="tip-chip" onclick="addToPrompt('[Subject]')">Subject (What)</div>
                                <div class="tip-chip" onclick="addToPrompt('[Style]')">Style (How it looks)</div>
                                <div class="tip-chip" onclick="addToPrompt('[Mood/Atmosphere]')">Mood</div>
                                <div class="tip-chip" onclick="addToPrompt('[Lighting]')">Lighting</div>
                                <div class="tip-chip" onclick="addToPrompt('[Quality: 8K, detailed, professional]')">Quality specs</div>
                            </div>
                            
                            <button class="btn-primary" style="margin-top: 15px;" onclick="analyzePrompt()">Analyze My Prompt</button>
                        </div>
                        <button class="mission-return" type="button" data-scroll-top="missions">‚Üë Back to mission tracker</button>
                        
                        <div style="margin-top: 40px; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                            <button onclick="window.location.href='presentation.html'" style="padding: 16px 32px; background: rgba(0,0,0,0.3); color: white; border: 2px solid rgba(255,255,255,0.3); border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; transition: transform 0.2s;">‚Üê Previous</button>
                            <button onclick="window.location.href='index.html'" style="padding: 16px 32px; background: rgba(0,0,0,0.3); color: white; border: 2px solid rgba(255,255,255,0.3); border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; transition: transform 0.2s;">Main Menu</button>
                            <button id="lesson3NextBtn" class="btn btn-primary is-disabled" type="button" data-next-lesson="lesson4" data-next-label="Next ‚Üí" disabled>Next ‚Üí</button>
                        </div>
                        <p class="next-lock-hint" id="lesson3NextHint">Complete any mission to unlock Lesson 4.</p>
                    </div>
                </div>

                <!-- Presentation Mode Content -->
                <div id="presentationMode">
                    <div class="challenge-section">
                        <h1 class="challenge-title">üé® AI Content Creation & Ethics</h1>
                        
                        <div style="margin: 30px 0;">
                            <h2 style="font-size: 28px; margin-bottom: 15px;">üìñ Overview</h2>
                            <p style="font-size: 16px; line-height: 1.8; opacity: 0.9;">
                                AI has revolutionized content creation, making it possible for anyone to generate professional-quality images, videos, music, and text in seconds. But with this power comes significant ethical responsibilities.
                            </p>
                        </div>

                        <div style="margin: 30px 0;">
                            <h2 style="font-size: 28px; margin-bottom: 15px;">üõ†Ô∏è Popular AI Content Tools</h2>
                            <div class="tool-showcase">
                                <div class="tool-card">
                                    <div style="font-size: 40px; margin-bottom: 10px;">üñºÔ∏è</div>
                                    <div style="font-weight: bold; margin-bottom: 10px;">DALL-E 3</div>
                                    <div style="font-size: 13px; opacity: 0.8; line-height: 1.5;">
                                        OpenAI's image generator. Best for realistic photos and precise instruction following. Integrated in ChatGPT Plus.
                                    </div>
                                </div>
                                <div class="tool-card">
                                    <div style="font-size: 40px; margin-bottom: 10px;">üé®</div>
                                    <div style="font-weight: bold; margin-bottom: 10px;">Midjourney</div>
                                    <div style="font-size: 13px; opacity: 0.8; line-height: 1.5;">
                                        Artistic and stylized images. Known for beautiful aesthetics. Discord-based interface.
                                    </div>
                                </div>
                                <div class="tool-card">
                                    <div style="font-size: 40px; margin-bottom: 10px;">üé¨</div>
                                    <div style="font-weight: bold; margin-bottom: 10px;">Runway Gen-3</div>
                                    <div style="font-size: 13px; opacity: 0.8; line-height: 1.5;">
                                        Text-to-video and image-to-video. Creates short, high-quality video clips.
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="ethics-warning" style="margin: 40px 0;">
                            <div class="ethics-title">‚ö†Ô∏è Critical Ethics Issues</div>
                            <div style="margin-top: 15px; line-height: 1.8;">
                                <p style="margin-bottom: 15px;"><strong>1. Copyright & Ownership</strong></p>
                                <ul style="margin-left: 20px; margin-bottom: 20px;">
                                    <li>AI models trained on copyrighted work without permission</li>
                                    <li>Who owns AI-generated content? (Still legally unclear)</li>
                                    <li>Can you sell AI art commercially?</li>
                                </ul>

                                <p style="margin-bottom: 15px;"><strong>2. Deepfakes & Misinformation</strong></p>
                                <ul style="margin-left: 20px; margin-bottom: 20px;">
                                    <li>Creating fake videos of real people</li>
                                    <li>Manipulating public opinion</li>
                                    <li>Revenge porn and harassment</li>
                                </ul>

                                <p style="margin-bottom: 15px;"><strong>3. Artist Impact</strong></p>
                                <ul style="margin-left: 20px; margin-bottom: 20px;">
                                    <li>AI trained on artists' work without consent</li>
                                    <li>Job displacement for creatives</li>
                                    <li>Devaluation of human creativity</li>
                                </ul>

                                <p style="margin-bottom: 15px;"><strong>4. Consent & Privacy</strong></p>
                                <ul style="margin-left: 20px;">
                                    <li>Voice cloning without permission</li>
                                    <li>Using someone's likeness</li>
                                    <li>Training data privacy concerns</li>
                                </ul>
                            </div>
                        </div>

                        <div style="margin: 40px 0;">
                            <h2 style="font-size: 28px; margin-bottom: 15px;">‚ú® Prompt Engineering Mastery</h2>
                            <div style="background: rgba(0, 0, 0, 0.3); border-radius: 15px; padding: 25px;">
                                <p style="margin-bottom: 20px;"><strong>The Perfect Prompt Formula:</strong></p>
                                <div style="background: rgba(255, 215, 0, 0.1); border-left: 4px solid #FFD700; padding: 15px; margin-bottom: 15px;">
                                    <code style="font-size: 14px; line-height: 1.8;">
                                        [Subject] + [Action/Pose] + [Style] + [Mood/Atmosphere] + [Lighting] + [Camera Angle] + [Quality Specs]
                                    </code>
                                </div>

                                <p style="margin: 20px 0 15px 0;"><strong>Example Breakdown:</strong></p>
                                <div style="background: rgba(0, 0, 0, 0.2); padding: 20px; border-radius: 10px; font-size: 14px; line-height: 1.8;">
                                    <span style="color: #FFD700;">Subject:</span> "A majestic lion"<br>
                                    <span style="color: #FF6B9D;">Action:</span> "roaring on a cliff edge"<br>
                                    <span style="color: #9D4EDD;">Style:</span> "cinematic photography"<br>
                                    <span style="color: #00D9FF;">Mood:</span> "powerful and dramatic"<br>
                                    <span style="color: #10B981;">Lighting:</span> "golden hour backlighting"<br>
                                    <span style="color: #F59E0B;">Camera:</span> "low angle shot"<br>
                                    <span style="color: #EF4444;">Quality:</span> "8K, highly detailed, professional"
                                </div>
                            </div>
                        </div>

                        <div style="margin: 40px 0;">
                            <h2 style="font-size: 28px; margin-bottom: 15px;">üéØ Best Practices</h2>
                            <div style="display: grid; gap: 15px;">
                                <div style="background: rgba(16, 185, 129, 0.2); border-left: 4px solid #10B981; padding: 20px; border-radius: 10px;">
                                    <strong>‚úÖ DO:</strong> Disclose when content is AI-generated
                                </div>
                                <div style="background: rgba(16, 185, 129, 0.2); border-left: 4px solid #10B981; padding: 20px; border-radius: 10px;">
                                    <strong>‚úÖ DO:</strong> Use AI to augment your creativity, not replace it
                                </div>
                                <div style="background: rgba(16, 185, 129, 0.2); border-left: 4px solid #10B981; padding: 20px; border-radius: 10px;">
                                    <strong>‚úÖ DO:</strong> Check usage rights before commercial use
                                </div>
                                <div style="background: rgba(239, 68, 68, 0.2); border-left: 4px solid #EF4444; padding: 20px; border-radius: 10px;">
                                    <strong>‚ùå DON'T:</strong> Create deepfakes of real people without consent
                                </div>
                                <div style="background: rgba(239, 68, 68, 0.2); border-left: 4px solid #EF4444; padding: 20px; border-radius: 10px;">
                                    <strong>‚ùå DON'T:</strong> Claim AI work as entirely your own creation
                                </div>
                                <div style="background: rgba(239, 68, 68, 0.2); border-left: 4px solid #EF4444; padding: 20px; border-radius: 10px;">
                                    <strong>‚ùå DON'T:</strong> Use AI to spread misinformation
                                </div>
                            </div>
                        </div>

                        <div style="text-align: center; margin-top: 40px;">
                            <button class="btn btn-primary" onclick="window.lessonMode && window.lessonMode.setMode('game')">Start Activities ‚Üí</button>
                        </div>

                        <section class="key-takeaways" aria-label="Lesson 3 key takeaways">
                            <h2 class="section-title">Key Takeaways</h2>
                            <div class="takeaway-grid">
                                <article class="takeaway-card">
                                    <span class="takeaway-label">1</span>
                                    <h3>Brief like a director</h3>
                                    <p>Subject + action + style + mood + quality beats a single sentence. The more precise your cue, the less cleanup later.</p>
                                </article>
                                <article class="takeaway-card">
                                    <span class="takeaway-label">2</span>
                                    <h3>Ethics is a feature</h3>
                                    <p>Credit influences, disclose AI assist, and double-check licenses before publishing. Transparency builds trust.</p>
                                </article>
                                <article class="takeaway-card">
                                    <span class="takeaway-label">3</span>
                                    <h3>AI is collaborative</h3>
                                    <p>Use the model for drafts and iteration loops, then apply human taste for final polish and context.</p>
                                </article>
                            </div>
                        </section>

                        <div class="footer-nav"></div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div id="notification" class="notification hidden">
        <div id="notificationContent"></div>
    </div>

    <script>
        const LESSON_ID = 'lesson3';
        const QUIZ_XP = 50;
        const CHECKPOINTS = {
            imageChallenge: { xp: 75, label: 'Image Creation Challenge' },
            videoChallenge: { xp: 100, label: 'Video Creation Challenge' },
            promptAnalyzer: { xp: 50, label: 'Prompt Analyzer' },
            quiz0: { xp: QUIZ_XP, label: 'Ethics Quiz Question 1' },
            quiz1: { xp: QUIZ_XP, label: 'Ethics Quiz Question 2' },
            quiz2: { xp: QUIZ_XP, label: 'Ethics Quiz Question 3' }
        };
        const MISSION_STEPS = [
            { id: 'imageChallenge', label: 'Image Remix Lab', anchor: '#missionImage', checkpoints: ['imageChallenge'] },
            { id: 'videoChallenge', label: 'Video Sprint', anchor: '#missionVideo', checkpoints: ['videoChallenge'] },
            { id: 'ethicsQuiz', label: 'Ethics Gauntlet', anchor: '#missionQuiz', checkpoints: ['quiz0', 'quiz1', 'quiz2'] },
            { id: 'promptAnalyzer', label: 'Prompt Builder', anchor: '#missionPrompt', checkpoints: ['promptAnalyzer'] }
        ];
        const GAME_COMPLETION_IDS = ['imageChallenge', 'videoChallenge', 'promptAnalyzer', 'quiz0', 'quiz1', 'quiz2'];
        const LESSON4_UNLOCK_KEY = 'lesson4Unlocked';

        const state = {
            xp: 0,
            xpToNext: 375,
            mode: 'presentation'
        };
        const completedCheckpoints = new Set();
        const missionCompletionState = new Set();
        let tracker = null;
        let appProgress = null;
        let notificationTimer = null;
        let lesson4Unlocked = false;

        const ethicsQuestions = [
            {
                q: "You create an AI image in the style of a famous artist. What should you do?",
                options: [
                    "Claim it as your original work",
                    "Disclose it's AI-generated and mention the style inspiration",
                    "Sell it without mentioning AI",
                    "It's fine, AI art has no rules"
                ],
                correct: 1,
                explanation: "Always disclose AI generation and acknowledge style influences. Transparency is key!"
            },
            {
                q: "Can you create a deepfake video of a celebrity for your YouTube channel?",
                options: [
                    "Yes, if it's funny",
                    "Yes, if I label it as parody",
                    "No, not without explicit consent",
                    "Only if I monetize it"
                ],
                correct: 2,
                explanation: "Creating deepfakes without consent violates privacy and can cause harm, even with labels."
            },
            {
                q: "Who owns the copyright to an AI-generated image?",
                options: [
                    "You, the user",
                    "The AI company",
                    "It's public domain",
                    "It's legally unclear and varies by jurisdiction"
                ],
                correct: 3,
                explanation: "AI copyright is still being determined in courts. Check your tool's terms and local laws!"
            }
        ];

        document.addEventListener('DOMContentLoaded', () => {
            tracker = window.ProgressTracker || null;
            appProgress = window.AppProgress || null;
            hydrateProgress();
            loadEthicsQuiz();
            attachLessonChrome();
            updateUI();
            renderMissionTracker();
            updateLesson4ButtonState();
            setupMissionNavigation();
        });

        function hydrateProgress() {
            const saved = tracker ? tracker.getCheckpoints(LESSON_ID) : {};
            state.xp = 0;
            completedCheckpoints.clear();
            Object.entries(CHECKPOINTS).forEach(([id, meta]) => {
                if (saved && saved[id]) {
                    completedCheckpoints.add(id);
                    state.xp += meta.xp;
                }
            });
            if (saved && typeof saved.xpEarned === 'number') {
                state.xp = Math.max(state.xp, Number(saved.xpEarned));
            }
            lesson4Unlocked = Boolean(saved && saved[LESSON4_UNLOCK_KEY]);
            missionCompletionState.clear();
            MISSION_STEPS.forEach((mission) => {
                if (mission.checkpoints.every((cp) => completedCheckpoints.has(cp))) {
                    missionCompletionState.add(mission.id);
                }
            });
            syncLessonStatus();
            renderMissionTracker();
            updateLesson4ButtonState();
        }

        function startActivity(type) {
            if (type === 'image') {
                alert('üé® Image Creation Challenge!\n\nGo to ChatGPT (with Plus) or another AI image tool and create 3 images:\n\n1. A realistic photo\n2. An artistic illustration\n3. An abstract concept\n\nWhen done, come back and click "Mark Complete" (feature coming soon!)');
                completeCheckpoint('imageChallenge');
            } else if (type === 'video') {
                alert('üé¨ Video Creation Challenge!\n\nGo to Runway (runway.ml) or similar tool and create a 5-second video.\n\nTry text-to-video or image-to-video!\n\nWhen done, come back and mark complete.');
                completeCheckpoint('videoChallenge');
            }
        }

        function updateUI() {
            if (window.AILesson && typeof window.AILesson.updateXPBar === 'function') {
                window.AILesson.updateXPBar({ xp: state.xp, xpToNext: state.xpToNext, barId: 'xpBar', textId: 'xpText' });
            } else {
                const xpPercent = (state.xp / state.xpToNext) * 100;
                const xpBar = document.getElementById('xpBar');
                const xpText = document.getElementById('xpText');
                if (xpBar) xpBar.style.width = `${xpPercent}%`;
                if (xpText) xpText.textContent = `${state.xp}/${state.xpToNext}`;
            }
        }

        function showNotification(message) {
            const notification = document.getElementById('notification');
            const content = document.getElementById('notificationContent');
            if (!notification || !content) return;
            content.innerHTML = `<div style="font-size: 18px; font-weight: bold;">${message}</div>`;
            notification.classList.remove('hidden');
            notification.classList.add('show');
            clearTimeout(notificationTimer);
            notificationTimer = setTimeout(() => notification.classList.add('hidden'), 3200);
        }

        function addToPrompt(text) {
            const input = document.getElementById('promptInput');
            input.value += (input.value ? ' ' : '') + text;
            input.focus();
        }

        function analyzePrompt() {
            const prompt = document.getElementById('promptInput').value;
            if (!prompt.trim()) {
                alert('Please enter a prompt first!');
                return;
            }

            const components = {
                subject: /(?:a |an |the )?\w+/i.test(prompt),
                style: /(style|painted|photo|illustration|render)/i.test(prompt),
                mood: /(atmosphere|mood|feeling|emotion)/i.test(prompt),
                quality: /(8k|4k|detailed|high quality|professional)/i.test(prompt)
            };

            let score = Object.values(components).filter(Boolean).length;
            let feedback = `Prompt Analysis: ${score}/4 components detected\n\n`;
            
            if (!components.subject) feedback += '‚ùå Add a clear subject\n';
            else feedback += '‚úÖ Subject found\n';
            
            if (!components.style) feedback += '‚ùå Add style/medium\n';
            else feedback += '‚úÖ Style found\n';
            
            if (!components.mood) feedback += '‚ùå Add mood/atmosphere\n';
            else feedback += '‚úÖ Mood found\n';
            
            if (!components.quality) feedback += '‚ùå Add quality specs\n';
            else feedback += '‚úÖ Quality specs found\n';

            if (score >= 3) {
                const newlyCompleted = completeCheckpoint('promptAnalyzer');
                feedback += newlyCompleted ? '\nüéâ Great prompt! +50 XP' : '\n‚ú® Prompt logged already‚ÄîXP previously claimed.';
            }

            alert(feedback);
        }

        // Load ethics quiz
        function loadEthicsQuiz() {
            let html = '';
            ethicsQuestions.forEach((q, i) => {
                html += `
                    <div style="margin-bottom: 30px;">
                        <div style="font-weight: bold; margin-bottom: 15px;">${i + 1}. ${q.q}</div>
                        <div class="quiz-options" id="quiz${i}">
                            ${q.options.map((opt, j) => `
                                <div class="quiz-option" onclick="answerQuestion(${i}, ${j}, ${q.correct})">${opt}</div>
                            `).join('')}
                        </div>
                        <div id="feedback${i}" style="display: none; margin-top: 15px; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 10px;"></div>
                    </div>
                `;
            });
            document.getElementById('quizContainer').innerHTML = html;
        }

        function answerQuestion(qIndex, answer, correct) {
            const options = document.querySelectorAll(`#quiz${qIndex} .quiz-option`);
            options.forEach(opt => opt.style.pointerEvents = 'none');
            
            if (answer === correct) {
                options[answer].classList.add('correct');
                const checkpointId = `quiz${qIndex}`;
                const freshlyCompleted = completeCheckpoint(checkpointId, { silentIfDuplicate: true });
                const xpCopy = freshlyCompleted ? '+50 XP' : 'XP already claimed';
                document.getElementById(`feedback${qIndex}`).innerHTML = `
                    <div style="color: #10B981; font-weight: bold; margin-bottom: 10px;">‚úÖ Correct! ${xpCopy}</div>
                    <div>${ethicsQuestions[qIndex].explanation}</div>
                `;
            } else {
                options[answer].classList.add('incorrect');
                options[correct].classList.add('correct');
                document.getElementById(`feedback${qIndex}`).innerHTML = `
                    <div style="color: #EF4444; font-weight: bold; margin-bottom: 10px;">‚ùå Not quite!</div>
                    <div>${ethicsQuestions[qIndex].explanation}</div>
                `;
            }
            
            document.getElementById(`feedback${qIndex}`).style.display = 'block';
        }

        function completeCheckpoint(id, { silentIfDuplicate = false } = {}) {
            const meta = CHECKPOINTS[id];
            if (!meta) return false;
            if (completedCheckpoints.has(id)) {
                if (!silentIfDuplicate) {
                    showNotification(`${meta.label} already completed.`);
                }
                return false;
            }

            completedCheckpoints.add(id);
            if (tracker) {
                tracker.setCheckpoint(LESSON_ID, id, true);
            }
            maybeUnlockLesson4(id);
            handleMissionCompletionForCheckpoint(id);
            renderMissionTracker();
            updateLesson4ButtonState();
            grantXP(meta.xp, meta.label);
            return true;
        }

        function handleMissionCompletionForCheckpoint(checkpointId) {
            const mission = MISSION_STEPS.find((step) => step.checkpoints.includes(checkpointId));
            if (!mission || missionCompletionState.has(mission.id)) return;
            const isComplete = mission.checkpoints.every((cp) => completedCheckpoints.has(cp));
            if (isComplete) {
                missionCompletionState.add(mission.id);
                scrollToMissionHub();
            }
        }

        function renderMissionTracker() {
            const container = document.getElementById('missionTracker');
            const summary = document.getElementById('missionBoardSummary');
            if (!container) return;
            container.innerHTML = '';
            let completedMissions = 0;
            MISSION_STEPS.forEach((mission, index) => {
                const completedCount = mission.checkpoints.filter((cp) => completedCheckpoints.has(cp)).length;
                const total = mission.checkpoints.length;
                const status = completedCount >= total ? 'completed' : (completedCount > 0 ? 'in-progress' : 'not-started');
                if (status === 'completed') completedMissions++;
                const button = document.createElement('button');
                button.type = 'button';
                button.className = `mission-chip ${status}`;
                button.dataset.missionAnchor = mission.anchor;
                button.innerHTML = `
                    <span class="mission-index">${index + 1}</span>
                    <div class="mission-body">
                        <span class="mission-title">${mission.label}</span>
                        <span class="mission-progress">${completedCount}/${total} complete</span>
                    </div>
                    <span class="mission-status-icon">${status === 'completed' ? '‚úÖ' : status === 'in-progress' ? '‚è≥' : '‚Ä¢'}</span>
                `;
                container.appendChild(button);
            });
            if (summary) {
                summary.textContent = `${completedMissions}/${MISSION_STEPS.length} missions complete`;
            }
        }

        function setupMissionNavigation() {
            const trackerEl = document.getElementById('missionTracker');
            if (trackerEl) {
                trackerEl.addEventListener('click', (event) => {
                    const chip = event.target.closest('.mission-chip');
                    if (!chip || !chip.dataset.missionAnchor) return;
                    const target = document.querySelector(chip.dataset.missionAnchor);
                    if (target) target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                });
            }

            document.querySelectorAll('[data-scroll-top="missions"]').forEach((btn) => {
                btn.addEventListener('click', (event) => {
                    event.preventDefault();
                    scrollToMissionHub();
                });
            });
        }

        function scrollToMissionHub() {
            const hub = document.getElementById('missionHubTop');
            if (hub) {
                hub.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        function maybeUnlockLesson4(checkpointId) {
            if (lesson4Unlocked) return;
            if (!GAME_COMPLETION_IDS.includes(checkpointId)) return;
            lesson4Unlocked = true;
            if (tracker) {
                tracker.setCheckpoint(LESSON_ID, LESSON4_UNLOCK_KEY, true);
            }
            updateLesson4ButtonState();
            showNotification('Lesson 4 unlocked! Keep creating.');
        }

        function updateLesson4ButtonState() {
            const nextBtn = document.getElementById('lesson3NextBtn');
            const hint = document.getElementById('lesson3NextHint');
            if (!nextBtn) return;
            if (lesson4Unlocked) {
                nextBtn.disabled = false;
                nextBtn.classList.remove('is-disabled');
                if (hint) {
                    hint.textContent = 'Lesson 4 unlocked! Continue whenever you are ready.';
                    hint.classList.add('unlocked');
                }
            } else {
                nextBtn.disabled = true;
                nextBtn.classList.add('is-disabled');
                if (hint) {
                    hint.textContent = 'Complete any mission to unlock Lesson 4.';
                    hint.classList.remove('unlocked');
                }
            }
        }

        function grantXP(amount, contextLabel) {
            const delta = Number(amount) || 0;
            if (!delta) return;
            state.xp += delta;

            if (tracker) {
                tracker.setCheckpoint(LESSON_ID, 'xpEarned', state.xp);
            }

            if (appProgress && typeof appProgress.addXP === 'function') {
                appProgress.addXP(delta);
            } else if (tracker && typeof tracker.addXP === 'function') {
                tracker.addXP(delta);
            }

            updateUI();
            showNotification(`+${delta} XP ¬∑ ${contextLabel}`);
            syncLessonStatus();
        }

        function syncLessonStatus() {
            const total = Object.keys(CHECKPOINTS).length;
            const completed = completedCheckpoints.size;
            if (completed >= total) {
                markLessonComplete();
            } else if (completed > 0) {
                setLessonStatus('in-progress');
            } else {
                setLessonStatus('not-started');
            }
        }

        function markLessonComplete() {
            if (appProgress && typeof appProgress.markLessonComplete === 'function') {
                appProgress.markLessonComplete(LESSON_ID);
            } else if (tracker && typeof tracker.markLessonComplete === 'function') {
                tracker.markLessonComplete(LESSON_ID);
            }
        }

        function setLessonStatus(status) {
            if (appProgress && typeof appProgress.setLessonStatus === 'function') {
                appProgress.setLessonStatus(LESSON_ID, status);
            } else if (tracker && typeof tracker.setLessonStatus === 'function') {
                tracker.setLessonStatus(LESSON_ID, status);
            }
        }

        function attachLessonChrome() {
            const lessonApi = window.AILesson;
            if (!lessonApi) return;
            window.lessonMode = lessonApi.initModeToggle({
                defaultMode: 'presentation',
                gamePanelId: 'gameMode',
                presentationPanelId: 'presentationMode',
                gameButtonId: 'gameBtn',
                presentationButtonId: 'presentBtn'
            });
            lessonApi.updateXPBar({ xp: state.xp, xpToNext: state.xpToNext });
        }
    </script>
</body>
</html>
