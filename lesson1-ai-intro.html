<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self'; connect-src 'self';">
    <title>Lesson 1: Prompt Wizardry Warm-Up ‚ö°Ô∏è</title>

    <link rel="stylesheet" href="styles/shared.css">
    <style>
        .lesson-shell { display: flex; flex-direction: column; gap: 24px; }
        .content-grid { display: flex; flex-direction: column; gap: 24px; }
        .mode-selector { display: flex; gap: 12px; margin-bottom: 16px; }
        .challenge-section { display: flex; flex-direction: column; gap: 24px; }
        .challenge-title { font-size: 34px; }
        .challenge-desc { color: var(--color-muted); line-height: 1.6; }
        .activity-card { border-radius: var(--radius-lg); border: 1px solid rgba(255, 255, 255, 0.15); background: rgba(255, 255, 255, 0.05); padding: 24px; display: flex; flex-direction: column; gap: 16px; }
        .activity-meta { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; font-size: 14px; color: var(--color-muted); }
        .activity-meta span { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; background: rgba(255, 255, 255, 0.08); border-radius: 999px; }
        .activity-body { display: grid; gap: 18px; }
        .learning-grid { display: grid; gap: 18px; }
        .learning-card { border-radius: var(--radius-lg); border: 1px solid rgba(255, 255, 255, 0.15); padding: 20px; background: rgba(0, 0, 0, 0.25); }
        .learning-card h3 { margin-bottom: 10px; font-size: 20px; }
        .learning-card ul { margin-left: 20px; line-height: 1.7; }
        .voice-grid { display: grid; gap: 16px; }
        .chat-window { border-radius: var(--radius-lg); border: 1px solid rgba(255, 255, 255, 0.15); background: rgba(0, 0, 0, 0.25); padding: 18px; min-height: 220px; display: flex; flex-direction: column; gap: 12px; overflow-y: auto; }
        .message-bubble { max-width: 80%; padding: 12px 16px; border-radius: 18px; line-height: 1.5; font-size: 15px; display: inline-flex; flex-direction: column; gap: 6px; }
        .message-meta { font-size: 11px; text-transform: uppercase; letter-spacing: 0.08em; opacity: 0.7; }
        .message-user { align-self: flex-end; background: linear-gradient(135deg, #10B981, #059669); color: #fff; border-bottom-right-radius: 4px; }
        .message-ai { align-self: flex-start; background: rgba(255, 255, 255, 0.12); border-bottom-left-radius: 4px; }
        .empty-state { color: var(--color-muted); text-align: center; font-size: 14px; padding: 24px 0; }
        .chat-controls { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; }
        .chat-controls select { flex: 1; min-width: 180px; padding: 10px 12px; border-radius: var(--radius-md); border: 1px solid rgba(255, 255, 255, 0.25); background: rgba(0, 0, 0, 0.35); color: inherit; }
        .probability-visuals { border-radius: var(--radius-lg); border: 1px solid rgba(255, 255, 255, 0.12); padding: 18px; background: rgba(0, 0, 0, 0.25); display: flex; flex-direction: column; gap: 12px; }
        .probability-row { display: flex; align-items: center; gap: 12px; }
        .probability-word { width: 90px; font-size: 14px; }
        .probability-track { flex: 1; height: 20px; border-radius: 10px; background: rgba(255, 255, 255, 0.08); overflow: hidden; }
        .probability-fill { height: 100%; border-radius: 10px; display: flex; align-items: center; justify-content: flex-end; padding-right: 8px; font-size: 12px; font-weight: 600; color: #fff; }
        .prob-high { background: linear-gradient(135deg, #16a34a, #22c55e); }
        .prob-low { background: linear-gradient(135deg, #ef4444, #f97316); }
        .word-options { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; }
        .word-option { border-radius: var(--radius-md); border: 1px solid rgba(255, 255, 255, 0.18); padding: 12px; background: rgba(255, 255, 255, 0.04); color: inherit; cursor: pointer; text-align: left; display: flex; flex-direction: column; gap: 6px; transition: transform var(--transition-base), border-color var(--transition-base); }
        .word-option:hover:not([disabled]) { transform: translateY(-2px); border-color: var(--color-accent); }
        .word-option[disabled] { opacity: 0.6; cursor: not-allowed; }
        .word-option.correct { border-color: rgba(16, 185, 129, 0.8); background: rgba(16, 185, 129, 0.15); color: #bbf7d0; position: relative; }
        .word-option.correct::after { content: '‚úî'; position: absolute; top: 12px; right: 12px; font-weight: 700; color: #22c55e; }
        .word-option.incorrect { border-color: rgba(248, 113, 113, 0.9); animation: shake 0.25s ease; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-4px); } 75% { transform: translateX(4px); } }
        .word-hint { font-size: 12px; color: var(--color-muted); }
        .feedback { border-radius: var(--radius-md); padding: 12px 16px; font-weight: 600; }
        .feedback .feedback-icon { margin-right: 8px; font-size: 18px; }
        .feedback-success { border: 1px solid rgba(16, 185, 129, 0.6); background: rgba(16, 185, 129, 0.1); color: #34d399; }
        .feedback-error { border: 1px solid rgba(248, 113, 113, 0.6); background: rgba(248, 113, 113, 0.15); color: #f87171; }
        .word-celebration { margin-top: 16px; padding: 14px 16px; border-radius: var(--radius-lg); background: rgba(16, 185, 129, 0.15); border: 1px solid rgba(16, 185, 129, 0.4); display: flex; align-items: center; gap: 12px; opacity: 0; transform: translateY(8px); transition: opacity 0.25s ease, transform 0.25s ease; }
        .word-celebration.show { opacity: 1; transform: translateY(0); }
        .celebration-icon { font-size: 26px; }
        .xp-chip { padding: 6px 12px; border-radius: 999px; background: rgba(34, 197, 94, 0.2); border: 1px solid rgba(34, 197, 94, 0.5); color: #bbf7d0; font-weight: 600; }
        .voice-progress-chip { font-size: 12px; letter-spacing: 0.08em; text-transform: uppercase; }
        .voice-progress-chip.goal-met { background: rgba(34, 197, 94, 0.25); border-color: rgba(34, 197, 94, 0.8); color: #ecfccb; }
        .tone-drop-zone { display: inline-flex; align-items: center; justify-content: center; padding: 10px 14px; min-width: 140px; border-radius: var(--radius-md); border: 2px dashed rgba(255, 255, 255, 0.25); text-transform: uppercase; font-weight: 600; cursor: pointer; transition: border-color var(--transition-base), background var(--transition-base); }
        .tone-drop-zone.active { border-style: solid; border-color: var(--color-accent); background: rgba(16, 185, 129, 0.15); }
        .tone-drop-zone.filled { border-style: solid; border-color: #facc15; background: rgba(250, 204, 21, 0.15); color: #fde047; }
        .tone-word-bank { display: flex; flex-wrap: wrap; gap: 10px; }
        .tone-word { padding: 8px 14px; border-radius: var(--radius-md); border: 1px solid rgba(255, 255, 255, 0.2); background: rgba(255, 255, 255, 0.04); cursor: grab; text-transform: capitalize; font-weight: 600; transition: background var(--transition-base), border-color var(--transition-base); }
        .tone-word:active { cursor: grabbing; }
        .tone-word:hover { background: rgba(255, 255, 255, 0.12); }
        .tone-word.selected { background: var(--color-accent); color: #0f172a; border-color: var(--color-accent); }
        .tone-output { border-radius: var(--radius-lg); border: 1px solid rgba(255, 255, 255, 0.18); padding: 16px; background: rgba(0, 0, 0, 0.3); font-size: 16px; line-height: 1.6; }
        .status-pill { font-size: 12px; text-transform: uppercase; letter-spacing: 0.08em; color: var(--color-muted); }
        .notification { position: fixed; bottom: 24px; right: 24px; background: rgba(4, 4, 4, 0.85); border-radius: var(--radius-md); padding: 14px 18px; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.35); display: none; }
        .notification.show { display: block; }
        .notification strong { color: #34d399; }
        .xp-cluster { display: flex; align-items: center; gap: 12px; }
        .restart-lesson-btn { border: 1px solid rgba(255, 255, 255, 0.4); background: rgba(0, 0, 0, 0.35); color: #fff; border-radius: 999px; width: 38px; height: 38px; display: inline-flex; align-items: center; justify-content: center; cursor: pointer; font-size: 18px; transition: background var(--transition-base), transform var(--transition-base); }
        .restart-lesson-btn:hover, .restart-lesson-btn:focus-visible { background: rgba(255, 255, 255, 0.15); transform: translateY(-1px); outline: none; }
        .progress-pills { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; }
        .progress-pill { padding: 6px 14px; border-radius: 999px; font-size: 13px; letter-spacing: 0.04em; background: rgba(255, 255, 255, 0.12); color: #fff; border: 1px solid rgba(255, 255, 255, 0.2); }
        .activity-progress { font-size: 13px; letter-spacing: 0.04em; text-transform: uppercase; color: rgba(255, 255, 255, 0.7); }
        .activity-progress.complete { color: #34d399; }
        .voice-selection-note { font-size: 13px; color: rgba(255, 255, 255, 0.7); margin: 0; }
        .xp-fill.xp-pulse { animation: xpPulse 0.65s ease; }
        @keyframes xpPulse { 0% { box-shadow: 0 0 0 0 rgba(250, 204, 21, 0.6); } 100% { box-shadow: 0 0 0 14px rgba(250, 204, 21, 0); } }
        .learning-showcase { display: grid; grid-template-columns: minmax(0, 1fr); gap: 20px; margin-top: 24px; }
        .story-card { border-radius: var(--radius-lg); border: 1px solid rgba(255, 255, 255, 0.18); background: rgba(255, 255, 255, 0.04); padding: 20px; display: flex; flex-direction: column; gap: 16px; min-height: 240px; }
        .story-card.story-hero { background: linear-gradient(135deg, rgba(15, 23, 42, 0.85), rgba(79, 70, 229, 0.55)); border-color: rgba(255, 255, 255, 0.25); color: #fff; }
        .story-meta { display: flex; gap: 10px; flex-wrap: wrap; font-size: 13px; text-transform: uppercase; letter-spacing: 0.08em; opacity: 0.9; }
        .story-actions { display: flex; flex-wrap: wrap; gap: 12px; }
        .story-header h3 { margin-bottom: 4px; font-size: 20px; }
        .story-header p { margin: 0; color: var(--color-muted); }
        .prompt-compare { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; margin-top: 16px; }
        .prompt-block { border-radius: var(--radius-md); border: 1px solid rgba(255, 255, 255, 0.18); padding: 16px; background: rgba(255, 255, 255, 0.06); }
        .prompt-label { font-size: 13px; letter-spacing: 0.06em; text-transform: uppercase; color: var(--color-muted); margin-bottom: 8px; }
        .prompt-text { font-family: 'Courier New', Courier, monospace; font-size: 14px; background: rgba(0, 0, 0, 0.25); padding: 10px; border-radius: var(--radius-sm); margin-bottom: 10px; }
        .prompt-output { font-size: 15px; line-height: 1.5; }
        .prompt-weight { font-size: 12px; margin-top: 10px; color: var(--color-muted); }
        .cost-callout { margin-top: 18px; padding: 16px; border-radius: var(--radius-md); border: 1px dashed rgba(250, 204, 21, 0.7); background: rgba(250, 204, 21, 0.1); }
        .cost-callout strong { color: #facc15; }
        .step-selector { display: flex; flex-wrap: wrap; gap: 8px; }
        .step-pill { flex: 1 1 45%; border-radius: 999px; padding: 10px 16px; border: 1px solid rgba(255, 255, 255, 0.18); background: rgba(0, 0, 0, 0.25); color: inherit; cursor: pointer; font-weight: 600; transition: background var(--transition-base), border-color var(--transition-base); }
        .step-pill.active { background: var(--color-accent); color: #0f172a; border-color: var(--color-accent); }
        .step-detail { border-radius: var(--radius-md); border: 1px solid rgba(255, 255, 255, 0.15); padding: 16px; background: rgba(255, 255, 255, 0.03); min-height: 180px; }
        .step-detail ul { margin-left: 20px; line-height: 1.6; }
        .tone-palette { display: flex; flex-wrap: wrap; gap: 8px; }
        .tone-btn { border-radius: var(--radius-md); border: 1px solid rgba(255, 255, 255, 0.2); background: rgba(255, 255, 255, 0.05); color: inherit; padding: 8px 14px; cursor: pointer; font-weight: 600; transition: background var(--transition-base), border-color var(--transition-base); }
        .tone-btn.active { background: linear-gradient(135deg, #22d3ee, #0ea5e9); color: #0f172a; border-color: rgba(14, 165, 233, 0.6); }
        .tone-transcript { border-radius: var(--radius-md); border: 1px solid rgba(255, 255, 255, 0.15); padding: 14px; min-height: 110px; line-height: 1.6; background: rgba(15, 23, 42, 0.35); }
        .tone-tip { font-size: 13px; color: var(--color-muted); }
        .drop-stack { display: flex; flex-direction: column; gap: 10px; }
        .drop-toggle { border-radius: var(--radius-md); border: 1px solid rgba(255, 255, 255, 0.2); background: rgba(0, 0, 0, 0.35); color: inherit; padding: 12px 14px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; font-weight: 600; }
        .drop-toggle.open { border-color: var(--color-accent); background: rgba(16, 185, 129, 0.15); }
        .drop-panel { border-radius: var(--radius-md); border-left: 3px solid var(--color-accent); background: rgba(255, 255, 255, 0.05); padding: 12px 16px; display: none; }
        .drop-panel.open { display: block; }
        .drop-panel ul { margin-left: 18px; line-height: 1.6; }
        .mission-checklist { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 12px; }
        .mission-checklist li { border-radius: var(--radius-md); border: 1px solid rgba(255, 255, 255, 0.15); padding: 12px 14px; background: rgba(255, 255, 255, 0.04); display: flex; flex-direction: column; gap: 6px; }
        .check-btn { align-self: flex-start; border-radius: 999px; border: 1px solid rgba(255, 255, 255, 0.35); background: transparent; color: inherit; padding: 6px 16px; text-transform: uppercase; font-size: 12px; letter-spacing: 0.08em; cursor: pointer; transition: background var(--transition-base), border-color var(--transition-base); }
        .check-btn.completed { background: linear-gradient(135deg, #10b981, #22c55e); color: #041316; border-color: transparent; }
        .callout-card { margin-top: 24px; }
        .callout-actions { display: flex; flex-wrap: wrap; gap: 12px; margin-top: 16px; }
        .next-lesson-hint { margin-top: 10px; font-size: 14px; color: var(--color-muted); }
        .next-lesson-hint.unlocked { color: #34d399; }
        @media (max-width: 768px) {
            .challenge-title { font-size: 26px; }
            .chat-controls { flex-direction: column; align-items: stretch; }
            .chat-controls select { width: 100%; }
            .word-options { grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); }
            .story-card { min-height: auto; }
            .step-pill { flex: 1 1 100%; }
        }
    </style>
    <script defer src="scripts/shared.js"></script>
    <script defer src="scripts/progress.js"></script>
    <script defer src="scripts/nav.js"></script>
</head>
<body data-lesson-id="lesson1">
    <div class="container lesson-shell">
        <div class="header">
            <div class="logo">‚ö°Ô∏è Lesson 1: Prompt Wizardry Warm-Up</div>
            <div class="breadcrumb"></div>
            <div class="stats">
                <div>
                    <div class="stat-label">XP</div>
                    <div class="xp-cluster">
                        <div class="xp-bar">
                            <div class="xp-fill" id="xpBar"></div>
                            <span class="xp-label" id="xpText">0/110</span>
                        </div>
                        <button class="restart-lesson-btn" type="button" id="restartLessonBtn" title="Restart Lesson 1 warm-ups" aria-label="Restart Lesson 1 warm-ups">‚Ü∫</button>
                    </div>
                </div>
            </div>
            <div class="progress-pills">
                <div class="progress-pill" id="lessonProgressPill">Lesson Progress: 0/3 activities</div>
                <div class="progress-pill" id="globalProgressPill">Total XP: 0</div>
            </div>
        </div>

        <div class="content-grid">
            <div class="main-panel">
                <div class="mode-selector">
                    <button class="mode-btn" id="gameBtn">üéÆ Game Mode</button>
                    <button class="mode-btn active" id="presentBtn">üìö Learn</button>
                </div>

                <div id="gameMode" class="hidden">
                    <div class="challenge-section">
                        <h1 class="challenge-title">Build AI instincts through three mini-games</h1>
                        <p class="challenge-desc">These are the exact warm-ups from Prompt Wizardry: mimic a character, predict the next word, then flip the tone with a single adjective. Complete each section to earn XP and understand how tiny changes influence AI output.</p>

                        <div class="activity-card" id="wordPrediction">
                            <div class="activity-meta">
                                <span>üéØ Activity 1</span>
                                <span>Word Prediction Radar</span>
                                <span>Goal: choose the most likely completion</span>
                            </div>
                            <div class="activity-body">
                                <div class="status-pill">Sentence starter: Honesty is the best ___</div>
                                <p>AI predicts the next word by ranking what usually follows. Study the probabilities, then make your pick.</p>
                                <div class="probability-visuals" id="probabilityVisualization"></div>
                                <div class="word-options" id="wordOptions"></div>
                                <div class="activity-progress" id="wordProgress" aria-live="polite">Word radar progress: Choose the best completion.</div>
                                <div class="word-celebration hidden" id="wordCelebration" aria-live="polite"></div>
                                <div class="feedback hidden" id="wordFeedback"></div>
                            </div>
                        </div>

                        <div class="activity-card" id="voiceMimic">
                            <div class="activity-meta">
                                <span>üé§ Activity 2</span>
                                <span>Voice Mimic Chat</span>
                                <span>Goal: try 3 characters</span>
                                <span class="xp-chip voice-progress-chip" id="voiceProgressChip">Voices tried: 0/3</span>
                            </div>
                            <div class="activity-body voice-grid">
                                <div class="status-pill">Prompt: "Honesty is the best policy."</div>
                                <div class="chat-window" id="mimicMessages">
                                    <div class="empty-state" id="mimicEmpty">Select a character voice and press Send to see how the AI response shifts.</div>
                                </div>
                                <div class="chat-controls">
                                    <label for="characterSelect" style="font-size: 14px; opacity: 0.8;">Rewrite it in the voice of</label>
                                    <select id="characterSelect" aria-label="Select a character voice"></select>
                                    <button class="btn btn-primary" id="sendMimic">Send</button>
                                </div>
                                <p class="voice-selection-note" id="voiceSelectionNote">Selected voice: Mickey Mouse</p>
                            </div>
                        </div>

                        <div class="activity-card" id="toneLab">
                            <div class="activity-meta">
                                <span>üé≠ Activity 3</span>
                                <span>Tone Changes Everything</span>
                                <span>Goal: test multiple tones</span>
                            </div>
                            <div class="activity-body">
                                <p>Write a <span id="toneDropZone" class="tone-drop-zone" role="button" tabindex="0">choose tone</span> message to my boss to call out sick today.</p>
                                <div class="status-pill">Tip: click a tone word or drag it into the slot. Tap the slot to clear.</div>
                                <div class="tone-word-bank" id="toneWordBank"></div>
                                <div class="tone-output hidden" id="toneOutput"></div>
                            </div>
                        </div>

                        <div class="activity-card">
                            <div class="activity-meta">
                                <span>‚úÖ Next Mission</span>
                                <span>Lesson 2 ¬∑ AI Literacy</span>
                            </div>
                            <div class="activity-body">
                                <p>Feeling confident after the warm-up reps? Jump straight into Lesson 2's learn mode to dig into AI literacy drills and the full F.A.C.T.S. framework.</p>
                                <button class="btn btn-primary" id="lesson1NextBtn" type="button" data-next-lesson="auto" data-next-label="Go to Lesson 2 ¬∑ Learn Mode">Go to Lesson 2 ¬∑ Learn Mode</button>
                                <p class="next-lesson-hint">Keep practicing the warm-ups, or hop into Lesson 2 whenever you're ready.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="presentationMode">
                    <div class="challenge-section">
                        <h1 class="challenge-title">Lesson 1 ¬∑ Understanding AI Personalities</h1>
                        <p class="challenge-desc">This is your fun, witty crash course in what AI actually is, why tone is the secret sauce, and how prediction math runs the whole show. Think science fair meets improv club.</p>

                        <section class="learning-showcase">
                            <article class="story-card">
                                <div class="story-header">
                                    <h3>Do you have to be polite to the AI?</h3>
                                    <p>Toggle one word and track how probability weights, tone, and even cloud costs shift.</p>
                                </div>
                                <p>Try this sentence pair and observe how "please" nudges the model toward softer verbs and higher confidence in caretaking language.</p>
                                <div class="prompt-compare" aria-label="Prompt comparison">
                                    <div class="prompt-block">
                                        <div class="prompt-label">Prompt A</div>
                                        <div class="prompt-text">Write a loving message to my spouse that I'll be late tonight.</div>
                                        <p class="prompt-output"><strong>Model reply:</strong> "Hey love, running late tonight but I can't wait to catch up when I'm home."</p>
                                        <p class="prompt-weight">Top token confidence: "running" 62%, "late" 21%, "love" 8%</p>
                                    </div>
                                    <div class="prompt-block">
                                        <div class="prompt-label">Prompt B</div>
                                        <div class="prompt-text">Write a loving message to my spouse that I'll be late tonight please.</div>
                                        <p class="prompt-output"><strong>Model reply:</strong> "Hey love, I'm so sorry but I'll be late tonight‚Äîplease save me a hug when I get in."</p>
                                        <p class="prompt-weight">Top token confidence: "sorry" 74%, "please" 18%, "hug" 6%</p>
                                    </div>
                                </div>
                                <p class="prompt-weight">Adding "please" raises the probability of apologetic verbs and inserts persuasion tokens like "sorry" or "hug" because the model sees politeness as a strong cue for empathy.</p>
                                <div class="cost-callout">
                                    <p><strong>Token cost reality:</strong> Assuming OpenAI's GPT-4o mini input pricing of about $0.000005 per token, the single word "please" (~1 token) costs ~$0.000005 every time. A conversation that uses "please" and "thank you" 20 times adds roughly $0.0002 in compute per user. At a million users per day, those niceties translate to about $200 in extra daily compute spend.</p>
                                </div>
                            </article>

                            <article class="story-card">
                                <div class="story-header">
                                    <h3>Pick a beat to expand</h3>
                                    <p>Tap each pill and get a guided breakdown of what to watch for.</p>
                                </div>
                                <div class="step-selector" role="tablist" aria-label="Lesson 1 learning beats">
                                    <button class="step-pill active" data-learning-step="pattern">Pattern engine</button>
                                    <button class="step-pill" data-learning-step="probability">Probability radar</button>
                                    <button class="step-pill" data-learning-step="tone">Tone switches</button>
                                    <button class="step-pill" data-learning-step="bias">Bias spotter</button>
                                </div>
                                <div class="step-detail" aria-live="polite">
                                    <h4 id="learningStepTitle">AI = Predictive Pattern Engine</h4>
                                    <p id="learningStepBody">LLMs read billions of sentences and keep score of what tends to follow what. They remix what already exists‚Äîthey never invent true understanding.</p>
                                    <ul id="learningStepList">
                                        <li>It chains predictions token-by-token like improv for words.</li>
                                        <li>More context and constraints tighten the probability spread.</li>
                                        <li>Vague prompts default to "helpful corporate coworker" voice.</li>
                                    </ul>
                                </div>
                            </article>

                            <article class="story-card">
                                <div class="story-header">
                                    <h3>Tone dial sandbox</h3>
                                    <p>Click a tone to preview how a single adjective alters the vibe.</p>
                                </div>
                                <div class="tone-palette">
                                    <button class="tone-btn active" data-tone-explain="friendly">Friendly</button>
                                    <button class="tone-btn" data-tone-explain="urgent">Urgent</button>
                                    <button class="tone-btn" data-tone-explain="dramatic">Dramatic</button>
                                    <button class="tone-btn" data-tone-explain="skeptical">Skeptical</button>
                                </div>
                                <div class="tone-transcript" id="toneExplainOutput">Hey team! I'm testing prompts today and want a cheerful "camp counselor" vibe. Keep it upbeat, sprinkle emojis, and stay concise.</div>
                                <p class="tone-tip">Hint: stack tone word + audience + intent. Ex: "Give me a confident note for anxious parents."</p>
                            </article>

                        </section>

                        <div class="learning-card callout-card">
                            <h3>First-lesson energy</h3>
                            <p>Play with the characters, laugh at the wrong answers, and remind yourself that AI is a math-powered improv partner. The more specific you are about tone and audience, the more the model sounds like it belongs on your team.</p>
                            <p style="margin-top: 12px;">Ready for hands-on practice? Switch to Game Mode with any button labeled "Start mini-games."</p>
                            <div class="callout-actions">
                                <button class="btn btn-primary" data-jump-game="true">Go to game warm-ups</button>
                                <a class="btn btn-secondary" href="index.html#modules">Review the curriculum map</a>
                            </div>
                        </div>

                        <section class="key-takeaways" aria-label="Lesson 1 key takeaways">
                            <h2 class="section-title">Key Takeaways</h2>
                            <div class="takeaway-grid">
                                <article class="takeaway-card">
                                    <span class="takeaway-label">1</span>
                                    <h3>LLMs remix probability</h3>
                                    <p>Every response is a ranked guess. Add specifics (audience, stakes, tone) to collapse the probability space and avoid generic replies.</p>
                                </article>
                                <article class="takeaway-card">
                                    <span class="takeaway-label">2</span>
                                    <h3>Tone is a control knob</h3>
                                    <p>Named characters, adjectives, and pacing cues instantly reshape delivery. Treat prompts like stage directions for your improv partner.</p>
                                </article>
                                <article class="takeaway-card">
                                    <span class="takeaway-label">3</span>
                                    <h3>Log the weird stuff</h3>
                                    <p>Screenshot hallucinations, bias, or overconfidence. Those artifacts become fuel for future guardrails, escalations, or retraining.</p>
                                </article>
                            </div>
                        </section>

                        <div class="footer-nav"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="notification" class="notification hidden">
        <div id="notificationContent"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const LESSON_ID = 'lesson1';
            const tracker = window.ProgressTracker || null;
            const characters = [
                { id: 'mickey', name: 'Mickey Mouse', response: 'Gosh! Being truthful is always the top policy!' },
                { id: 'scrooge', name: 'Ebenezer Scrooge', response: 'Bah! Yet honesty remains the soundest policy for profit.' },
                { id: 'cat', name: 'A Cat', response: 'Mew... honesty keeps the bowl full.' },
                { id: 'dog', name: 'A Dog', response: 'Woof! Honesty is the best bone to chew on!' },
                { id: 'santa', name: 'Santa Claus', response: 'Ho ho ho! Honesty is the merriest policy of all.' },
                { id: 'sherlock', name: 'Sherlock Holmes', response: 'Elementary, my dear Watson: honesty is the best policy.' },
                { id: 'yoda', name: 'Yoda', response: 'Best policy, honesty is, hmmm.' },
                { id: 'pirate', name: 'Pirate', response: "Arrr, speakin' true be the finest code o' conduct." },
                { id: 'shakespeare', name: 'Shakespeare', response: 'Verily, honesty doth prove the noblest policy.' }
            ];

            const probabilityConfig = [
                { word: 'Policy', probability: 94, type: 'high', hint: 'This is the most common phrase completion.' },
                { word: 'Banana', probability: 2, type: 'low', hint: "This doesn't fit the pattern." },
                { word: 'Spaceship', probability: 1, type: 'low', hint: 'AI rarely predicts random words.' },
                { word: 'Revenge', probability: 3, type: 'low', hint: 'This contradicts the meaning.' }
            ];

            const toneWords = ['compelling', 'pathetic', 'mad', 'happy', 'distracted', 'short', 'formal', 'friendly', 'urgent', 'apologetic'];
            const toneResponses = {
                compelling: "Hey boss, I'm really under the weather and won't be able to give my best today. I'll make up for it when I'm back.",
                pathetic: "Hey boss, I'm sooo sick... I can't even move. Please let me stay home.",
                mad: "Boss, I'm sick. Don't expect me in.",
                happy: "Morning! Feeling pretty ill today, so I'll rest up and be back with a smile tomorrow.",
                distracted: "Hi - um, I'm sick today, can't come. Thanks.",
                short: 'Sick today, staying home.',
                formal: 'Dear Boss, I regret to inform you that illness prevents my attendance today.',
                friendly: "Hey Boss! I'm feeling rough today, going to rest and catch you tomorrow.",
                urgent: "Boss, I woke up really sick. Need to stay home and recover.",
                apologetic: "I'm sorry, but I'm too sick to come in today. I'll keep you posted."
            };
            const REQUIRED_MIMIC_VARIETY = 3;

            const learningStepsContent = {
                pattern: {
                    title: 'AI = Predictive Pattern Engine',
                    body: 'LLMs read billions of sentences and keep score of what tends to follow. They remix probability, not original thought.',
                    bullets: [
                        'It chains predictions token-by-token like improv for words.',
                        'Extra context narrows the possibilities and keeps replies on-brand.',
                        'If you stay vague, it defaults to a polite corporate coworker vibe.'
                    ]
                },
                probability: {
                    title: 'Probability Radar Brain',
                    body: 'Every option gets ranked. The model boosts words that statistically fit the prompt and tones you set.',
                    bullets: [
                        'Temperature sliders decide how adventurous those picks get.',
                        'Ask ‚Äúshow me the top three alternates‚Äù to compare reasoning.',
                        'Pair odds with intuition: if the % feels wrong, rewrite the cue.'
                    ]
                },
                tone: {
                    title: 'Tone Switchboard',
                    body: 'Tone cues treat the AI like a voice actor. Specific adjectives, audiences, and intents reframe the same facts.',
                    bullets: [
                        'Anchor the voice (‚ÄúYou are a sarcastic teen journalist...‚Äù).',
                        'Layer emotion + pacing (‚Äúurgent + three short sentences‚Äù).',
                        'Audit for stereotypes before you hit send; you are the director.'
                    ]
                },
                bias: {
                    title: 'Bias + Safety Spotter',
                    body: 'Your job is to pause when the model sounds overconfident, exclusionary, or forgetful.',
                    bullets: [
                        'Challenge big claims: ‚ÄúWhat sources back that up?‚Äù',
                        'Swap one perspective for many (‚Äúgive me the student + parent POV‚Äù).',
                        'Document weird replies so you can retrain or escalate later.'
                    ]
                }
            };

            const toneExplainSamples = {
                friendly: "Hey team! I'm testing prompts today and want a cheerful 'camp counselor' vibe. Keep it upbeat, sprinkle emojis, and stay concise.",
                urgent: "Heads up! I need a straight-to-the-point status update in the next 5 minutes‚Äîno fluff, just actionable bullets.",
                dramatic: "Picture this like a movie trailer. Build suspense, add sensory words, and end with a bold call to action.",
                skeptical: "I appreciate the enthusiasm, but walk me through the evidence calmly. Cite the source or flag if you're unsure."
            };

            const savedCheckpoints = tracker ? tracker.getCheckpoints(LESSON_ID) : {};
            const savedVoiceAttempts = Array.isArray(savedCheckpoints.voiceAttempts)
                ? savedCheckpoints.voiceAttempts.filter(Boolean)
                : [];
            const TOTAL_LESSON_XP = 110;
            const state = {
                xpToNext: TOTAL_LESSON_XP,
                xp: 0,
                voiceAttempts: new Set(savedVoiceAttempts),
                mimicComplete: Boolean(savedCheckpoints.mimicComplete),
                wordComplete: Boolean(savedCheckpoints.wordComplete),
                toneComplete: Boolean(savedCheckpoints.toneComplete),
                messages: []
            };
            state.xp = (state.mimicComplete ? 30 : 0) + (state.wordComplete ? 40 : 0) + (state.toneComplete ? 40 : 0);
            const initialCompleted = (state.mimicComplete ? 1 : 0) + (state.wordComplete ? 1 : 0) + (state.toneComplete ? 1 : 0);
            if (initialCompleted === 0 && state.xp > 0) {
                state.xp = 0;
            }
            const needsLegacyVoiceGrant = state.mimicComplete && state.voiceAttempts.size < REQUIRED_MIMIC_VARIETY;
            if (needsLegacyVoiceGrant) {
                while (state.voiceAttempts.size < REQUIRED_MIMIC_VARIETY) {
                    state.voiceAttempts.add(`legacy-${state.voiceAttempts.size + 1}`);
                }
                if (tracker) {
                    tracker.setCheckpoint(LESSON_ID, 'voiceAttempts', Array.from(state.voiceAttempts));
                }
            }

            const elements = {
                mimicMessages: document.getElementById('mimicMessages'),
                mimicEmpty: document.getElementById('mimicEmpty'),
                characterSelect: document.getElementById('characterSelect'),
                sendMimic: document.getElementById('sendMimic'),
                voiceProgressChip: document.getElementById('voiceProgressChip'),
                probabilityVisualization: document.getElementById('probabilityVisualization'),
                wordOptions: document.getElementById('wordOptions'),
                wordFeedback: document.getElementById('wordFeedback'),
                wordCelebration: document.getElementById('wordCelebration'),
                toneDropZone: document.getElementById('toneDropZone'),
                toneWordBank: document.getElementById('toneWordBank'),
                toneOutput: document.getElementById('toneOutput'),
                notification: document.getElementById('notification'),
                notificationContent: document.getElementById('notificationContent'),
                nextLessonButton: document.getElementById('lesson1NextBtn'),
                nextLessonHint: document.querySelector('.next-lesson-hint'),
                lessonProgressPill: document.getElementById('lessonProgressPill'),
                globalProgressPill: document.getElementById('globalProgressPill'),
                learningStepButtons: document.querySelectorAll('[data-learning-step]'),
                learningStepTitle: document.getElementById('learningStepTitle'),
                learningStepBody: document.getElementById('learningStepBody'),
                learningStepList: document.getElementById('learningStepList'),
                toneExplainButtons: document.querySelectorAll('[data-tone-explain]'),
                toneExplainOutput: document.getElementById('toneExplainOutput'),
                dropToggles: document.querySelectorAll('[data-drop]'),
                missionButtons: document.querySelectorAll('.check-btn'),
                wordProgress: document.getElementById('wordProgress'),
                voiceSelectionNote: document.getElementById('voiceSelectionNote'),
                restartButton: document.getElementById('restartLessonBtn'),
                xpBarFill: document.getElementById('xpBar'),
                xpBarText: document.getElementById('xpText')
            };

            let notificationTimer;
            let celebrationTimer;
            let selectedTone = null;

            function getCompletedActivitiesCount() {
                return ['mimicComplete', 'wordComplete', 'toneComplete'].reduce((count, key) => count + (state[key] ? 1 : 0), 0);
            }

            function isLessonFullyComplete() {
                return getCompletedActivitiesCount() === 3;
            }

            function persistVoiceAttempts() {
                if (!tracker) return;
                tracker.setCheckpoint(LESSON_ID, 'voiceAttempts', Array.from(state.voiceAttempts));
            }

            function updateVoiceProgress() {
                if (!elements.voiceProgressChip) return;
                const voicesTried = Math.min(state.voiceAttempts.size, REQUIRED_MIMIC_VARIETY);
                elements.voiceProgressChip.textContent = `Voices tried: ${voicesTried}/${REQUIRED_MIMIC_VARIETY}`;
                elements.voiceProgressChip.classList.toggle('goal-met', voicesTried >= REQUIRED_MIMIC_VARIETY);
            }

            function updateVoiceSelectionNote() {
                if (!elements.voiceSelectionNote || !elements.characterSelect) return;
                const selectedId = elements.characterSelect.value;
                const character = characters.find((entry) => entry.id === selectedId);
                if (character) {
                    elements.voiceSelectionNote.textContent = `Selected voice: ${character.name}`;
                } else {
                    elements.voiceSelectionNote.textContent = 'Select a voice to get started.';
                }
            }

            function updateProgressPills() {
                if (elements.lessonProgressPill) {
                    const completedCount = getCompletedActivitiesCount();
                    elements.lessonProgressPill.textContent = `Lesson Progress: ${completedCount}/3 activities`;
                }

                if (elements.globalProgressPill) {
                    if (tracker) {
                        const overview = tracker.getOverview();
                        const lessonLabel = overview.total ? `${overview.completed}/${overview.total} lessons` : `${overview.completed} lessons`;
                        elements.globalProgressPill.textContent = `Total XP: ${overview.xp} ¬∑ ${lessonLabel}`;
                    } else {
                        elements.globalProgressPill.textContent = `Total XP: ${state.xp}`;
                    }
                }
            }

            function syncLessonStatus() {
                if (!tracker) return;
                const completedCount = getCompletedActivitiesCount();
                if (completedCount === 0) {
                    tracker.setLessonStatus(LESSON_ID, 'not-started');
                } else if (completedCount < 3) {
                    tracker.setLessonStatus(LESSON_ID, 'in-progress');
                } else {
                    tracker.markLessonComplete(LESSON_ID);
                }
            }

            function handleLessonProgressChange() {
                syncLessonStatus();
                updateProgressPills();
                updateNextLessonGate();
            }

            function updateNextLessonGate() {
                if (!elements.nextLessonButton || !elements.nextLessonHint) return;
                const remaining = 3 - getCompletedActivitiesCount();
                if (remaining <= 0) {
                    elements.nextLessonButton.disabled = false;
                    elements.nextLessonHint.textContent = 'Warm-ups cleared! Lesson 2 is unlocked.';
                    elements.nextLessonHint.classList.add('unlocked');
                    elements.nextLessonButton.setAttribute('title', 'Launch Lesson 2 learn mode');
                    return;
                }

                elements.nextLessonButton.disabled = true;
                elements.nextLessonHint.classList.remove('unlocked');
                const activityLabel = remaining === 1 ? 'activity' : 'activities';
                elements.nextLessonHint.textContent = `Finish ${remaining} more ${activityLabel} to unlock Lesson 2.`;
                elements.nextLessonButton.setAttribute('title', 'Complete every warm-up to unlock Lesson 2');
            }

            function showNotification(message) {
                if (!elements.notification || !elements.notificationContent) return;
                elements.notificationContent.innerHTML = `<strong>XP Update:</strong> ${message}`;
                elements.notification.classList.remove('hidden');
                elements.notification.classList.add('show');
                clearTimeout(notificationTimer);
                notificationTimer = setTimeout(() => {
                    elements.notification.classList.add('hidden');
                    elements.notification.classList.remove('show');
                }, 2200);
            }

            function pulseXPBar() {
                if (!elements.xpBarFill) return;
                elements.xpBarFill.classList.remove('xp-pulse');
                void elements.xpBarFill.offsetWidth;
                elements.xpBarFill.classList.add('xp-pulse');
            }

            function updateXPBar() {
                if (window.AILesson && typeof window.AILesson.updateXPBar === 'function') {
                    window.AILesson.updateXPBar({ xp: state.xp, xpToNext: state.xpToNext, barId: 'xpBar', textId: 'xpText' });
                } else {
                    const bar = elements.xpBarFill;
                    const text = elements.xpBarText;
                    if (bar) bar.style.width = `${(state.xp / state.xpToNext) * 100}%`;
                    if (text) text.textContent = `${state.xp}/${state.xpToNext}`;
                }
                pulseXPBar();
            }

            function grantXP(amount, reason) {
                state.xp = Math.min(state.xpToNext, state.xp + amount);
                updateXPBar();
                showNotification(`${reason} (+${amount} XP)`);
                if (tracker) {
                    tracker.addXP(amount);
                }
                updateProgressPills();
            }

            function renderMessages() {
                if (!elements.mimicMessages) return;
                elements.mimicMessages.innerHTML = '';
                if (!state.messages.length) {
                    elements.mimicEmpty.classList.remove('hidden');
                    return;
                }
                elements.mimicEmpty.classList.add('hidden');
                state.messages.forEach((msg) => {
                    const bubble = document.createElement('div');
                    bubble.className = `message-bubble ${msg.role === 'user' ? 'message-user' : 'message-ai'}`;
                    const meta = document.createElement('div');
                    meta.className = 'message-meta';
                    meta.textContent = msg.role === 'user' ? 'You' : 'AI Assistant';
                    const text = document.createElement('div');
                    text.className = 'message-text';
                    text.textContent = msg.text;
                    bubble.appendChild(meta);
                    bubble.appendChild(text);
                    elements.mimicMessages.appendChild(bubble);
                });
                elements.mimicMessages.scrollTop = elements.mimicMessages.scrollHeight;
            }

            function handleSend() {
                const selectedId = elements.characterSelect.value;
                const character = characters.find((c) => c.id === selectedId);
                if (!character) return;
                state.messages.push({ role: 'user', text: `Honesty is the best policy. Rewrite this in the voice of ${character.name}.` });
                state.messages.push({ role: 'assistant', text: character.response });
                state.voiceAttempts.add(character.id);
                persistVoiceAttempts();
                renderMessages();
                updateVoiceProgress();
                if (!state.mimicComplete && state.voiceAttempts.size >= REQUIRED_MIMIC_VARIETY) {
                    state.mimicComplete = true;
                    grantXP(30, 'Unlocked Mimic Insight');
                    if (tracker) {
                        tracker.setCheckpoint(LESSON_ID, 'mimicComplete', true);
                    }
                    handleLessonProgressChange();
                } else if (!state.mimicComplete) {
                    updateNextLessonGate();
                }
            }

            function buildProbabilityBars() {
                if (!elements.probabilityVisualization) return;
                probabilityConfig.forEach((opt) => {
                    const row = document.createElement('div');
                    row.className = 'probability-row';
                    const label = document.createElement('span');
                    label.className = 'probability-word';
                    label.textContent = opt.word;
                    const track = document.createElement('div');
                    track.className = 'probability-track';
                    const fill = document.createElement('div');
                    fill.className = `probability-fill ${opt.type === 'high' ? 'prob-high' : 'prob-low'}`;
                    fill.style.width = `${opt.probability}%`;
                    fill.textContent = `${opt.probability}%`;
                    track.appendChild(fill);
                    row.appendChild(label);
                    row.appendChild(track);
                    elements.probabilityVisualization.appendChild(row);
                });
            }

            function setWordFeedback(message, type) {
                if (!elements.wordFeedback) return;
                const icon = type === 'success' ? '‚úÖ' : '‚ö†Ô∏è';
                elements.wordFeedback.innerHTML = `<span class="feedback-icon">${icon}</span><span>${message}</span>`;
                elements.wordFeedback.className = `feedback ${type === 'success' ? 'feedback-success' : 'feedback-error'}`;
                elements.wordFeedback.classList.remove('hidden');
            }

            function setWordProgress(message, isComplete = false) {
                if (!elements.wordProgress) return;
                elements.wordProgress.textContent = message;
                elements.wordProgress.classList.toggle('complete', Boolean(isComplete));
            }

            function showWordCelebration() {
                if (!elements.wordCelebration) return;
                elements.wordCelebration.innerHTML = `
                    <span class="celebration-icon">‚úÖ</span>
                    <div>
                        <strong>Policy locked in!</strong>
                        <p style="margin: 4px 0 0; font-size: 14px;">Prediction radar mastered‚Äîonward to tone flips.</p>
                    </div>
                    <span class="xp-chip">+40 XP</span>
                `;
                elements.wordCelebration.classList.remove('hidden');
                elements.wordCelebration.classList.add('show');
                clearTimeout(celebrationTimer);
                celebrationTimer = setTimeout(() => {
                    elements.wordCelebration.classList.remove('show');
                }, 2400);
            }

            function handleWordPick(word) {
                if (state.wordComplete) {
                    setWordProgress('Word radar progress: Complete! Use the restart icon to replay.', true);
                    return;
                }
                const optionButtons = elements.wordOptions ? elements.wordOptions.querySelectorAll('button') : [];
                if (word === 'Policy') {
                    state.wordComplete = true;
                    setWordFeedback('Correct! You think like an AI on this one. Moving to tone experiments...', 'success');
                    setWordProgress('Word radar progress: Complete! üéâ', true);
                    showWordCelebration();
                    grantXP(40, 'Prediction Mastery');
                    if (tracker) {
                        tracker.setCheckpoint(LESSON_ID, 'wordComplete', true);
                    }
                    handleLessonProgressChange();
                    optionButtons.forEach((btn) => {
                        const isAnswer = btn.dataset.wordChoice === 'Policy';
                        btn.disabled = true;
                        btn.classList.toggle('correct', isAnswer);
                        if (!isAnswer) {
                            btn.classList.remove('incorrect');
                        }
                    });
                    const toneSection = document.getElementById('toneLab');
                    if (toneSection) {
                        toneSection.scrollIntoView({ behavior: 'smooth' });
                    }
                } else {
                    setWordFeedback('You would not make a good robot‚Äîpick again.', 'error');
                    setWordProgress('Word radar progress: Try again‚Äîstudy the probability bars.', false);
                    const picked = Array.from(optionButtons).find((btn) => btn.dataset.wordChoice === word);
                    if (picked) {
                        picked.classList.add('incorrect');
                        setTimeout(() => picked.classList.remove('incorrect'), 450);
                    }
                }
            }

            function buildWordOptions() {
                if (!elements.wordOptions) return;
                probabilityConfig.forEach((opt) => {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.className = 'word-option';
                    button.dataset.wordChoice = opt.word;
                    button.innerHTML = `<span>${opt.word}</span><span class="word-hint">${opt.hint}</span>`;
                    button.addEventListener('click', () => handleWordPick(opt.word));
                    elements.wordOptions.appendChild(button);
                });
                if (state.wordComplete) {
                    hydrateWordActivity();
                } else {
                    setWordProgress('Word radar progress: Choose the best completion.', false);
                }
            }

            function hydrateWordActivity() {
                if (!state.wordComplete || !elements.wordOptions) return;
                const optionButtons = elements.wordOptions.querySelectorAll('button');
                optionButtons.forEach((btn) => {
                    const isAnswer = btn.dataset.wordChoice === 'Policy';
                    btn.disabled = true;
                    btn.classList.toggle('correct', isAnswer);
                    if (!isAnswer) {
                        btn.classList.remove('incorrect');
                    }
                });
                setWordFeedback('Prediction radar already cleared‚Äîuse restart to replay.', 'success');
                setWordProgress('Word radar progress: Complete! üéâ', true);
            }

            function setSelectedTone(tone) {
                selectedTone = tone;
                elements.toneDropZone.textContent = tone || 'choose tone';
                elements.toneDropZone.classList.toggle('filled', Boolean(tone));
                Array.from(elements.toneWordBank.children).forEach((btn) => {
                    btn.classList.toggle('selected', btn.dataset.tone === tone);
                });
                if (tone) {
                    elements.toneOutput.textContent = toneResponses[tone];
                    elements.toneOutput.classList.remove('hidden');
                    if (!state.toneComplete) {
                        state.toneComplete = true;
                        grantXP(40, 'Tone Mastery Achieved');
                        if (tracker) {
                            tracker.setCheckpoint(LESSON_ID, 'toneComplete', true);
                        }
                        handleLessonProgressChange();
                    }
                } else {
                    elements.toneOutput.classList.add('hidden');
                }
            }

            function buildToneWords() {
                if (!elements.toneWordBank) return;
                toneWords.forEach((word) => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'tone-word';
                    btn.textContent = word;
                    btn.draggable = true;
                    btn.dataset.tone = word;
                    btn.addEventListener('dragstart', (event) => {
                        event.dataTransfer.setData('text/plain', word);
                    });
                    btn.addEventListener('click', () => setSelectedTone(word));
                    elements.toneWordBank.appendChild(btn);
                });
            }

            function setActiveLearningStep(stepId) {
                if (!elements.learningStepButtons || !elements.learningStepButtons.length) return;
                const step = learningStepsContent[stepId];
                if (!step || !elements.learningStepTitle || !elements.learningStepBody || !elements.learningStepList) return;
                elements.learningStepButtons.forEach((btn) => {
                    btn.classList.toggle('active', btn.dataset.learningStep === stepId);
                });
                elements.learningStepTitle.textContent = step.title;
                elements.learningStepBody.textContent = step.body;
                elements.learningStepList.innerHTML = step.bullets.map((bullet) => `<li>${bullet}</li>`).join('');
            }

            function initLearningStepTabs() {
                if (!elements.learningStepButtons || !elements.learningStepButtons.length) return;
                elements.learningStepButtons.forEach((btn) => {
                    btn.addEventListener('click', () => setActiveLearningStep(btn.dataset.learningStep));
                });
                const defaultStep = elements.learningStepButtons[0].dataset.learningStep;
                setActiveLearningStep(defaultStep);
            }

            function setToneExplainSample(tone) {
                if (!elements.toneExplainButtons || !elements.toneExplainOutput) return;
                if (!toneExplainSamples[tone]) return;
                elements.toneExplainButtons.forEach((btn) => {
                    btn.classList.toggle('active', btn.dataset.toneExplain === tone);
                });
                elements.toneExplainOutput.textContent = toneExplainSamples[tone];
            }

            function initToneExplainSection() {
                if (!elements.toneExplainButtons || !elements.toneExplainButtons.length) return;
                elements.toneExplainButtons.forEach((btn) => {
                    btn.addEventListener('click', () => setToneExplainSample(btn.dataset.toneExplain));
                });
                const defaultTone = elements.toneExplainButtons[0].dataset.toneExplain;
                setToneExplainSample(defaultTone);
            }

            function initDropPanels() {
                if (!elements.dropToggles || !elements.dropToggles.length) return;
                elements.dropToggles.forEach((toggle) => {
                    const panel = document.querySelector(`.drop-panel[data-panel="${toggle.dataset.drop}"]`);
                    if (!panel) return;
                    toggle.addEventListener('click', () => {
                        const isOpen = toggle.classList.toggle('open');
                        toggle.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
                        panel.classList.toggle('open', isOpen);
                        panel.hidden = !isOpen;
                    });
                });
            }

            function initMissionChecklist() {
                if (!elements.missionButtons || !elements.missionButtons.length) return;
                elements.missionButtons.forEach((btn) => {
                    btn.addEventListener('click', () => {
                        const isComplete = btn.classList.toggle('completed');
                        btn.setAttribute('aria-pressed', isComplete ? 'true' : 'false');
                    });
                });
            }

            function initGameJumpers() {
                const jumpers = document.querySelectorAll('[data-jump-game="true"]');
                if (!jumpers.length) return;
                jumpers.forEach((btn) => {
                    btn.addEventListener('click', (event) => {
                        event.preventDefault();
                        if (window.lessonMode && typeof window.lessonMode.setMode === 'function') {
                            window.lessonMode.setMode('game');
                        }
                        const gamePanel = document.getElementById('gameMode');
                        if (gamePanel) {
                            gamePanel.scrollIntoView({ behavior: 'smooth' });
                        } else {
                            window.location.hash = '#gameMode';
                        }
                    });
                });
            }

            function resetLessonState() {
                state.voiceAttempts = new Set();
                state.messages = [];
                state.mimicComplete = false;
                state.wordComplete = false;
                state.toneComplete = false;
                state.xp = 0;
                selectedTone = null;

                if (tracker) {
                    if (typeof tracker.resetLesson === 'function') {
                        tracker.resetLesson(LESSON_ID);
                    } else {
                        tracker.setCheckpoint(LESSON_ID, 'voiceAttempts', []);
                        tracker.setCheckpoint(LESSON_ID, 'mimicComplete', false);
                        tracker.setCheckpoint(LESSON_ID, 'wordComplete', false);
                        tracker.setCheckpoint(LESSON_ID, 'toneComplete', false);
                        tracker.setLessonStatus(LESSON_ID, 'not-started');
                    }
                }

                if (elements.mimicEmpty) {
                    elements.mimicEmpty.classList.remove('hidden');
                }
                renderMessages();
                updateVoiceProgress();
                updateVoiceSelectionNote();
                persistVoiceAttempts();

                if (elements.missionButtons && elements.missionButtons.length) {
                    elements.missionButtons.forEach((btn) => {
                        btn.classList.remove('completed');
                        btn.setAttribute('aria-pressed', 'false');
                    });
                }

                if (elements.wordOptions) {
                    elements.wordOptions.innerHTML = '';
                    buildWordOptions();
                }
                if (elements.wordFeedback) {
                    elements.wordFeedback.classList.add('hidden');
                }
                if (elements.wordCelebration) {
                    elements.wordCelebration.classList.remove('show');
                    elements.wordCelebration.classList.add('hidden');
                }
                setWordProgress('Word radar progress: Choose the best completion.', false);

                state.toneComplete = false;
                setSelectedTone(null);

                updateXPBar();
                handleLessonProgressChange();
            }

            function handleLessonRestart() {
                const confirmed = window.confirm('Reset Lesson 1 progress so you can replay the warm-ups from scratch? This removes the XP you earned here.');
                if (!confirmed) return;
                const xpToRemove = Number(state.xp) || 0;
                if (xpToRemove > 0 && tracker && typeof tracker.adjustXP === 'function') {
                    tracker.adjustXP(-xpToRemove);
                }
                resetLessonState();
                showNotification('Lesson reset. Earn each XP burst again.');
            }


            function handleDragOver(event) {
                event.preventDefault();
                elements.toneDropZone.classList.add('active');
            }

            function handleDrop(event) {
                event.preventDefault();
                const tone = event.dataTransfer.getData('text/plain');
                setSelectedTone(tone);
                elements.toneDropZone.classList.remove('active');
            }

            function handleDragLeave(event) {
                if (!elements.toneDropZone.contains(event.relatedTarget)) {
                    elements.toneDropZone.classList.remove('active');
                }
            }

            elements.characterSelect.innerHTML = characters.map((character) => `<option value="${character.id}">${character.name}</option>`).join('');
            elements.sendMimic.addEventListener('click', handleSend);
            elements.characterSelect.addEventListener('change', () => {
                updateVoiceSelectionNote();
                elements.characterSelect.blur();
            });
            elements.characterSelect.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    handleSend();
                }
            });
            updateVoiceSelectionNote();

            buildProbabilityBars();
            buildWordOptions();
            buildToneWords();
            initLearningStepTabs();
            initToneExplainSection();
            initDropPanels();
            initMissionChecklist();

            elements.toneDropZone.addEventListener('dragover', handleDragOver);
            elements.toneDropZone.addEventListener('dragenter', handleDragOver);
            elements.toneDropZone.addEventListener('dragleave', handleDragLeave);
            elements.toneDropZone.addEventListener('drop', handleDrop);
            elements.toneDropZone.addEventListener('click', () => setSelectedTone(null));
            elements.toneDropZone.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' || event.key === ' ') {
                    event.preventDefault();
                    setSelectedTone(null);
                }
            });

            renderMessages();
            updateVoiceProgress();
            updateXPBar();
            handleLessonProgressChange();

            if (window.AILesson) {
                window.lessonMode = window.AILesson.initModeToggle({
                    defaultMode: 'presentation',
                    gamePanelId: 'gameMode',
                    presentationPanelId: 'presentationMode',
                    gameButtonId: 'gameBtn',
                    presentationButtonId: 'presentBtn'
                });
            }

            if (elements.nextLessonButton) {
                elements.nextLessonButton.addEventListener('click', () => {
                    if (elements.nextLessonButton.disabled) return;
                    window.location.href = 'presentation.html';
                });
            }

            initGameJumpers();
            if (elements.restartButton) {
                elements.restartButton.addEventListener('click', handleLessonRestart);
            }
        });
    </script>
</body>
</html>
